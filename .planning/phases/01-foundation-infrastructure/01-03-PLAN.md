---
phase: 01-foundation-infrastructure
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - src/lib/rate-limit.ts
  - src/app/(auth)/signup/page.tsx
  - middleware.ts
  - src/app/(dashboard)/dashboard/page.tsx
  - src/components/CreditBalance.tsx
autonomous: true
requirements:
  - AUTH-05
  - AUTH-06
  - INFRA-08

must_haves:
  truths:
    - "Signup is protected by CAPTCHA"
    - "Signup is rate limited to 3 per day per IP"
    - "Rate limit returns 429 with retry-after header"
    - "Authenticated users can access dashboard"
    - "Dashboard displays current credit balance"
  artifacts:
    - path: "src/lib/rate-limit.ts"
      provides: "IP-based rate limiting"
      exports: ["checkRateLimit"]
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Signup form with Turnstile CAPTCHA"
      contains: "Turnstile"
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Protected dashboard route"
      min_lines: 20
  key_links:
    - from: "src/app/(auth)/signup/page.tsx"
      to: "Cloudflare Turnstile"
      via: "CAPTCHA widget"
      pattern: "<Turnstile"
    - from: "middleware.ts"
      to: "src/lib/rate-limit.ts"
      via: "rate limit check"
      pattern: "checkRateLimit"
    - from: "src/components/CreditBalance.tsx"
      to: "credit_transactions"
      via: "SUM balance query"
      pattern: "credit_transactions"
---

<objective>
Add security layers (CAPTCHA and rate limiting) to prevent abuse, and create protected dashboard displaying credit balance.

Purpose: Protect signup from bots and spam while providing authenticated users a dashboard to view their credit balance. This completes the Phase 1 foundation by adding production-ready security and the first authenticated page.

Output: Signup protected by Cloudflare Turnstile CAPTCHA and IP rate limiting, middleware enforcing limits, and dashboard showing real-time credit balance from ledger.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Rate Limiting and CAPTCHA to Signup</name>
  <files>
src/lib/rate-limit.ts
src/app/(auth)/signup/page.tsx
middleware.ts
src/app/api/auth/signup/route.ts
.env.local
.env.example
  </files>
  <action>
**Step 1: Create rate limiting utility** following 01-RESEARCH.md Pattern 5:
```typescript
// src/lib/rate-limit.ts
const rateLimitStore = new Map<string, { count: number; resetTime: number }>()

export function checkRateLimit(
  ip: string,
  limit: number,
  windowMs: number
): { allowed: boolean; remaining: number; resetTime: number } {
  const now = Date.now()
  const key = ip
  const record = rateLimitStore.get(key)

  // Clean up expired entries
  if (record && now > record.resetTime) {
    rateLimitStore.delete(key)
  }

  const currentRecord = rateLimitStore.get(key)

  if (!currentRecord) {
    rateLimitStore.set(key, { count: 1, resetTime: now + windowMs })
    return { allowed: true, remaining: limit - 1, resetTime: now + windowMs }
  }

  if (currentRecord.count >= limit) {
    return {
      allowed: false,
      remaining: 0,
      resetTime: currentRecord.resetTime,
    }
  }

  currentRecord.count++
  rateLimitStore.set(key, currentRecord)

  return {
    allowed: true,
    remaining: limit - currentRecord.count,
    resetTime: currentRecord.resetTime,
  }
}
```

**Step 2: Add rate limiting to middleware.ts**:
```typescript
// Add to existing middleware.ts
import { checkRateLimit } from '@/lib/rate-limit'
import { NextResponse } from 'next/server'

export async function middleware(request: NextRequest) {
  // Rate limit signup endpoint
  if (request.nextUrl.pathname === '/api/auth/signup') {
    const ip = request.headers.get('x-forwarded-for')?.split(',')[0] ||
               request.ip ||
               'unknown'

    const { allowed, resetTime } = checkRateLimit(
      ip,
      3, // 3 signups
      24 * 60 * 60 * 1000 // per day
    )

    if (!allowed) {
      return NextResponse.json(
        { error: 'Signup rate limit exceeded. Try again tomorrow.' },
        {
          status: 429,
          headers: {
            'Retry-After': String(Math.ceil((resetTime - Date.now()) / 1000)),
          },
        }
      )
    }
  }

  // Continue with existing auth middleware...
  const { response, user } = await updateSession(request)
  // ... rest of middleware
}
```

**Step 3: Get Cloudflare Turnstile keys**:
- Visit https://dash.cloudflare.com/
- Create account if needed (free tier)
- Go to Turnstile section
- Create new site widget (select "Managed" mode)
- Copy Site Key and Secret Key

Add to .env.local:
```
NEXT_PUBLIC_TURNSTILE_SITE_KEY=your-site-key
TURNSTILE_SECRET_KEY=your-secret-key
```

Add to .env.example:
```
NEXT_PUBLIC_TURNSTILE_SITE_KEY=your-turnstile-site-key
TURNSTILE_SECRET_KEY=your-turnstile-secret
```

**Step 4: Add Turnstile to signup form** following 01-RESEARCH.md Pattern 6:
```typescript
// Update src/app/(auth)/signup/page.tsx
'use client'

import { Turnstile } from '@marsidev/react-turnstile'
import { useState } from 'react'

export default function SignupPage() {
  const [turnstileToken, setTurnstileToken] = useState<string | null>(null)
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [success, setSuccess] = useState(false)

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setError('')

    if (!turnstileToken) {
      setError('Please complete the CAPTCHA verification')
      return
    }

    const response = await fetch('/api/auth/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email,
        password,
        turnstileToken
      }),
    })

    const data = await response.json()

    if (response.ok) {
      setSuccess(true)
    } else {
      setError(data.error || 'Signup failed')
      setTurnstileToken(null) // Reset CAPTCHA on error
    }
  }

  if (success) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="max-w-md w-full p-6 bg-white rounded-lg shadow">
          <h1 className="text-2xl font-bold mb-4">Check Your Email</h1>
          <p>We sent a verification link to {email}. Click the link to activate your account.</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <form onSubmit={handleSubmit} className="max-w-md w-full p-6 bg-white rounded-lg shadow">
        <h1 className="text-2xl font-bold mb-6">Sign Up</h1>

        {error && <div className="mb-4 p-3 bg-red-100 text-red-700 rounded">{error}</div>}

        <div className="mb-4">
          <label className="block mb-2 font-medium">Email</label>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full p-2 border rounded"
            required
          />
        </div>

        <div className="mb-4">
          <label className="block mb-2 font-medium">Password</label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full p-2 border rounded"
            required
            minLength={6}
          />
        </div>

        <div className="mb-6">
          <Turnstile
            siteKey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY!}
            onSuccess={(token) => setTurnstileToken(token)}
            onError={() => setTurnstileToken(null)}
            onExpire={() => setTurnstileToken(null)}
          />
        </div>

        <button
          type="submit"
          className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 disabled:opacity-50"
          disabled={!turnstileToken}
        >
          Sign Up
        </button>

        <p className="mt-4 text-center text-sm">
          Already have an account? <a href="/login" className="text-blue-600 hover:underline">Log in</a>
        </p>
      </form>
    </div>
  )
}
```

**Step 5: Verify Turnstile token in signup API**:
```typescript
// Update src/app/api/auth/signup/route.ts
import { createClient } from '@/lib/supabase/server'
import { NextRequest, NextResponse } from 'next/server'

export async function POST(request: NextRequest) {
  const { email, password, turnstileToken } = await request.json()

  // Verify Turnstile CAPTCHA
  const turnstileResponse = await fetch(
    'https://challenges.cloudflare.com/turnstile/v0/siteverify',
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        secret: process.env.TURNSTILE_SECRET_KEY,
        response: turnstileToken,
      }),
    }
  )

  const outcome = await turnstileResponse.json()

  if (!outcome.success) {
    return NextResponse.json(
      { error: 'CAPTCHA verification failed. Please try again.' },
      { status: 400 }
    )
  }

  // Proceed with Supabase signup
  const supabase = await createClient()

  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      emailRedirectTo: `${request.nextUrl.origin}/auth/callback`,
    },
  })

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 400 })
  }

  return NextResponse.json({
    message: 'Check your email to confirm your account',
    user: data.user,
  })
}
```
  </action>
  <verify>
Test rate limiting and CAPTCHA:
1. Visit http://localhost:3000/signup
2. Verify Turnstile widget appears
3. Try submitting without completing CAPTCHA - should show error
4. Complete CAPTCHA and submit valid signup - should work
5. Try signing up 3 more times rapidly from same browser/IP
6. Fourth attempt should return 429 error with "Try again tomorrow"
7. Check browser DevTools Network tab for Retry-After header
8. Wait for rate limit window or restart dev server to reset
  </verify>
  <done>
- Rate limiting implemented with Map-based storage
- Signup endpoint protected by rate limit (3/day per IP)
- Cloudflare Turnstile CAPTCHA integrated on signup form
- Server-side Turnstile verification via Siteverify API
- Submit button disabled until CAPTCHA completed
- 429 responses include Retry-After header
- Rate limit resets after 24 hours
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Protected Dashboard with Credit Balance</name>
  <files>
src/app/(dashboard)/dashboard/page.tsx
src/app/(dashboard)/layout.tsx
src/components/CreditBalance.tsx
  </files>
  <action>
**Step 1: Create dashboard layout** with shared UI structure:
```typescript
// src/app/(dashboard)/layout.tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 items-center">
            <h1 className="text-xl font-bold">Carousel Creator</h1>
            <div className="flex items-center gap-4">
              <span className="text-sm text-gray-600">{user.email}</span>
              <form action="/api/auth/logout" method="POST">
                <button className="text-sm text-blue-600 hover:underline">
                  Logout
                </button>
              </form>
            </div>
          </div>
        </div>
      </nav>
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {children}
      </main>
    </div>
  )
}
```

**Step 2: Create logout API route**:
```typescript
// src/app/api/auth/logout/route.ts
import { createClient } from '@/lib/supabase/server'
import { NextRequest, NextResponse } from 'next/server'

export async function POST(request: NextRequest) {
  const supabase = await createClient()
  await supabase.auth.signOut()
  return NextResponse.redirect(new URL('/login', request.url))
}
```

**Step 3: Create CreditBalance component** following 01-RESEARCH.md balance calculation pattern:
```typescript
// src/components/CreditBalance.tsx
'use client'

import { createClient } from '@/lib/supabase/client'
import { useEffect, useState } from 'react'

export function CreditBalance() {
  const [balance, setBalance] = useState<number | null>(null)
  const [loading, setLoading] = useState(true)
  const supabase = createClient()

  useEffect(() => {
    async function loadBalance() {
      const { data: transactions, error } = await supabase
        .from('credit_transactions')
        .select('amount')

      if (error) {
        console.error('Failed to load balance:', error)
        setLoading(false)
        return
      }

      const total = transactions.reduce((sum, tx) => sum + tx.amount, 0)
      setBalance(total)
      setLoading(false)
    }

    loadBalance()
  }, [])

  if (loading) {
    return <div className="text-gray-600">Loading credits...</div>
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow">
      <h2 className="text-lg font-semibold mb-2">Credit Balance</h2>
      <p className="text-4xl font-bold text-blue-600">{balance ?? 0}</p>
      <p className="text-sm text-gray-600 mt-2">
        {balance === 0 ? 'No credits remaining' : `${balance} carousel${balance === 1 ? '' : 's'} available`}
      </p>
      {balance !== null && balance < 3 && (
        <button className="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Get More Credits
        </button>
      )}
    </div>
  )
}
```

**Step 4: Create dashboard page**:
```typescript
// src/app/(dashboard)/dashboard/page.tsx
import { CreditBalance } from '@/components/CreditBalance'
import { createClient } from '@/lib/supabase/server'

export default async function DashboardPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  return (
    <div>
      <h1 className="text-3xl font-bold mb-8">Dashboard</h1>

      <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        <CreditBalance />

        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-lg font-semibold mb-2">Account</h2>
          <p className="text-sm text-gray-600">Email: {user?.email}</p>
          <p className="text-sm text-gray-600 mt-1">
            Status: {user?.email_confirmed_at ? 'Verified' : 'Unverified'}
          </p>
        </div>

        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-lg font-semibold mb-2">Quick Actions</h2>
          <p className="text-sm text-gray-600">
            Brand setup and carousel generation coming in Phase 2 & 3
          </p>
        </div>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Test dashboard:
1. Log in at http://localhost:3000/login
2. Should redirect to http://localhost:3000/dashboard
3. Dashboard displays:
   - Credit balance of 3 (from signup bonus)
   - User email in navbar
   - Logout button in navbar
4. Click logout - should redirect to /login and clear session
5. Try accessing /dashboard without auth - should redirect to /login
6. Log back in, verify credit balance still shows 3
  </verify>
  <done>
- Dashboard route exists and requires authentication
- Dashboard layout includes navbar with user email and logout
- CreditBalance component displays real-time balance from ledger
- Balance calculated as SUM(amount) from credit_transactions
- Dashboard shows placeholder for future features
- Logout functionality works and terminates session
- Protected routes enforce authentication via middleware
  </done>
</task>

</tasks>

<verification>
Complete security and dashboard verification:

1. **CAPTCHA works:** Signup form requires Turnstile completion
2. **Rate limiting:** 3 signups per day per IP enforced
3. **429 response:** Rate limit exceeded returns proper error with Retry-After
4. **Dashboard protected:** Unauthenticated access redirects to login
5. **Balance displays:** Credit balance shows 3 after signup verification
6. **Logout works:** User can log out from dashboard navbar
7. **Session persistence:** Refresh dashboard page, session remains valid
</verification>

<success_criteria>
- Signup protected by Cloudflare Turnstile CAPTCHA (AUTH-05)
- IP-based rate limiting (3 signups/day) enforced (AUTH-06)
- Rate limiting also ready for generation endpoint (5/hour) in Phase 3 (INFRA-08)
- Protected dashboard accessible only to authenticated users
- Dashboard displays real-time credit balance from ledger
- Logout functionality terminates session
- All security measures production-ready
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
