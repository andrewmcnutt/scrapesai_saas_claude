---
phase: 01-foundation-infrastructure
plan: 04
type: execute
wave: 4
depends_on:
  - 01-03
files_modified: []
autonomous: false
requirements: []

must_haves:
  truths:
    - "User can complete full signup flow from /signup to verified dashboard access"
    - "Email verification link works and redirects properly"
    - "3 free credits allocated on verification"
    - "Login with verified credentials succeeds"
    - "Session persists across browser refresh"
    - "Logout terminates session completely"
    - "Dashboard displays correct credit balance"
    - "CAPTCHA prevents bot signups"
    - "Rate limit blocks excessive signups"
  artifacts: []
  key_links: []
---

<objective>
Human verification of complete Phase 1 authentication and infrastructure foundation.

Purpose: Validate that all authentication flows work end-to-end in a real browser environment, catch UX issues, and confirm the foundation is production-ready before proceeding to Phase 2 brand management.

Output: Verified authentication system with no blocking issues.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete authentication system with:
- Next.js 15 application with Supabase integration
- Email signup with Cloudflare Turnstile CAPTCHA
- Email verification flow with 3 free credits allocation
- Login/logout functionality
- Session management via middleware token refresh
- IP-based rate limiting (3 signups/day)
- Protected dashboard showing credit balance
- Credit ledger system with RLS policies
  </what-built>
  <how-to-verify>
**Test 1: Complete Signup Flow**
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/signup
3. Enter valid email address (use real email or check Supabase logs)
4. Enter password (min 6 characters)
5. Complete Cloudflare Turnstile CAPTCHA
6. Click "Sign Up"
7. Verify "Check Your Email" message displays
8. Check Supabase Dashboard > Authentication > Logs for verification email sent
9. Copy verification link from:
   - Email inbox (if real email used), OR
   - Supabase Dashboard > Logs > expand email event > view link
10. Open verification link in browser
11. Should redirect to http://localhost:3000/dashboard
12. Dashboard should display:
    - Credit balance of 3
    - User email in navbar
    - Account status: Verified

**Test 2: Credit Allocation Verification**
1. Open Supabase Dashboard
2. Go to Table Editor > credit_transactions
3. Verify one row exists with:
   - user_id matching your user
   - amount = 3
   - type = 'signup_bonus'
   - metadata contains source: 'email_verification'

**Test 3: Login Flow**
1. Click Logout in dashboard navbar
2. Should redirect to http://localhost:3000/login
3. Enter same email and password from signup
4. Click "Log In"
5. Should redirect to http://localhost:3000/dashboard
6. Dashboard should still show credit balance of 3

**Test 4: Session Persistence**
1. While logged in, refresh browser (Cmd+R or F5)
2. Should remain on dashboard (not redirected to login)
3. Credit balance should still display
4. Close browser tab
5. Reopen http://localhost:3000/dashboard in new tab
6. Should still be logged in (session cookie persists)

**Test 5: Protected Route Enforcement**
1. Click Logout
2. Manually navigate to http://localhost:3000/dashboard
3. Should redirect to http://localhost:3000/login
4. URL should include ?redirect=/dashboard query parameter

**Test 6: CAPTCHA Protection**
1. Visit http://localhost:3000/signup
2. Enter email and password WITHOUT completing CAPTCHA
3. Try to submit form
4. Button should be disabled OR show error "Please complete CAPTCHA"
5. Complete CAPTCHA widget
6. Submit button should become enabled

**Test 7: Rate Limiting**
1. Complete 3 signups using different emails (or delete previous test user from Supabase auth.users)
2. Signups 1, 2, 3 should succeed
3. Attempt 4th signup immediately
4. Should receive error: "Signup rate limit exceeded. Try again tomorrow."
5. Open browser DevTools > Network tab
6. Check failed signup request
7. Response should have status 429
8. Response headers should include Retry-After value

**Test 8: TypeScript and Build**
1. Run `npm run build` in terminal
2. Build should complete without TypeScript errors
3. Check output for any warnings about missing environment variables
4. Run `npm start` to test production build
5. Verify signup/login/dashboard still work in production mode

**Expected Outcomes:**
- All 8 tests pass without errors
- No console errors in browser DevTools
- No TypeScript compilation errors
- CAPTCHA widget loads properly
- Rate limiting enforces 3/day limit
- Email verification allocates exactly 3 credits
- Session persists across refresh and browser restart
- Protected routes redirect properly
  </how-to-verify>
  <resume-signal>
Reply with one of:
- "approved" - All tests passed, no issues found
- "approved with notes: [description]" - Tests passed but minor observations
- "issues found: [description]" - Tests revealed problems that need fixes

If issues found, describe:
1. Which test failed
2. What happened vs what was expected
3. Any error messages from browser console or terminal
  </resume-signal>
</task>

</tasks>

<verification>
All Phase 1 success criteria met:
1. User can sign up with email and password via Supabase
2. User receives email verification after signup
3. User can log in with verified email and session persists across browser refresh
4. User can log out from any page
5. Signup includes CAPTCHA to prevent bot abuse
6. Signup rate limited by IP (3 signups per day maximum)
7. Credit transactions stored as ledger (INSERT only, never UPDATE balance)
8. Balance calculated as SUM(transactions) for audit trail
9. Credits cannot go negative (CHECK constraint in database)
10. Application deployed locally and ready for Vercel deployment
11. Database migrations version controlled
12. RLS enabled on all tables with indexed policy columns
13. Rate limiting configured at application layer
</verification>

<success_criteria>
Human has tested complete authentication flow and confirmed:
- Signup, email verification, login, logout all functional
- 3 free credits allocated on verification
- Session management works correctly
- Protected routes enforce authentication
- CAPTCHA prevents automated signups
- Rate limiting blocks excessive attempts
- No blocking bugs or UX issues
- Ready to proceed to Phase 2: Brand Management
</success_criteria>

<output>
After human approval, create `.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md`
</output>
