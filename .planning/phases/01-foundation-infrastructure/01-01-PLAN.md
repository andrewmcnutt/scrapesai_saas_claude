---
phase: 01-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - next.config.ts
  - tsconfig.json
  - .env.local
  - .env.example
  - .gitignore
  - supabase/config.toml
  - supabase/migrations/20260221000001_initial_schema.sql
  - src/types/database.ts
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-05
  - INFRA-06
  - INFRA-07
  - CRED-06
  - CRED-07
  - CRED-08

must_haves:
  truths:
    - "Next.js 15 application runs locally on port 3000"
    - "Supabase project exists and is linked locally"
    - "Database migrations can be applied and rolled back"
    - "Credit transactions table exists with RLS enabled"
    - "TypeScript types are generated from database schema"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies and scripts"
      contains: "@supabase/supabase-js"
    - path: "supabase/migrations/20260221000001_initial_schema.sql"
      provides: "Credit transactions table with ledger pattern"
      contains: "CREATE TABLE credit_transactions"
    - path: "src/types/database.ts"
      provides: "TypeScript types from Supabase schema"
      min_lines: 20
  key_links:
    - from: "package.json"
      to: "@supabase/ssr"
      via: "dependency declaration"
      pattern: "@supabase/ssr"
    - from: "supabase/config.toml"
      to: "Supabase cloud project"
      via: "project_id configuration"
      pattern: "project_id"
---

<objective>
Initialize Next.js 15 App Router application with Supabase integration and database foundation using credit ledger pattern.

Purpose: Establish the project structure, build tooling, database schema, and local development environment required for all subsequent work. This creates the foundational infrastructure that authentication, credit system, and all features will build upon.

Output: Working Next.js 15 application with Supabase configured, database migrations ready, credit ledger table created with RLS policies, and TypeScript types generated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js 15 + Supabase Project</name>
  <files>
package.json
package-lock.json
next.config.ts
tsconfig.json
.env.local
.env.example
.gitignore
supabase/config.toml
src/app/layout.tsx
src/app/page.tsx
  </files>
  <action>
Create Next.js 15 application with TypeScript and App Router:

```bash
npx create-next-app@latest . --typescript --app --no-src-dir --tailwind --eslint --turbopack --import-alias "@/*"
```

Install Supabase and required dependencies:
```bash
npm install @supabase/supabase-js@latest @supabase/ssr@latest zod @marsidev/react-turnstile
npm install -D supabase
```

Initialize Supabase project locally:
```bash
npx supabase init
```

Create .env.example with placeholders:
```
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
TURNSTILE_SECRET_KEY=your-turnstile-secret
NEXT_PUBLIC_TURNSTILE_SITE_KEY=your-turnstile-site-key
```

Create actual .env.local (do NOT commit):
- Visit https://supabase.com/dashboard and create new project named "carousel-creator"
- Copy project URL and anon key from Settings > API
- Add to .env.local with actual values

Update .gitignore to include:
```
.env*.local
.vercel
```

Configure next.config.ts for Vercel deployment (minimal config, accept defaults from create-next-app).

Update tsconfig.json to include:
```json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "strict": true,
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

Create basic src/app/layout.tsx (accept create-next-app default) and src/app/page.tsx with placeholder "Carousel Creator SaaS".
  </action>
  <verify>
Run `npm run dev` and confirm:
- Application starts without errors
- http://localhost:3000 displays placeholder page
- No TypeScript compilation errors
- Run `npx supabase status` and confirm local Supabase is initialized
  </verify>
  <done>
- Next.js 15 application runs locally on port 3000
- All dependencies installed without conflicts
- .env.example committed, .env.local exists but gitignored
- Supabase CLI initialized with config.toml
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Database Schema with Credit Ledger</name>
  <files>
supabase/migrations/20260221000001_initial_schema.sql
src/types/database.ts
  </files>
  <action>
Create migration file for initial schema using Supabase CLI:
```bash
npx supabase migration new initial_schema
```

In the generated migration file (supabase/migrations/[timestamp]_initial_schema.sql), add SQL from 01-RESEARCH.md Pattern 4:

1. **Credit transactions table** (INSERT-only ledger):
```sql
-- Credit transactions ledger (immutable)
CREATE TABLE credit_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  amount INTEGER NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('signup_bonus', 'monthly_allocation', 'generation_deduction', 'refund')),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Index for fast balance calculation
CREATE INDEX idx_credit_transactions_user_id ON credit_transactions(user_id);

-- Enable RLS (CRITICAL: do this before adding policies)
ALTER TABLE credit_transactions ENABLE ROW LEVEL SECURITY;

-- RLS policy: users can view own transactions
CREATE POLICY "Users can view own transactions"
  ON credit_transactions
  FOR SELECT
  TO authenticated
  USING ((SELECT auth.uid()) = user_id);

-- RPC function for atomic credit deduction
CREATE OR REPLACE FUNCTION deduct_credit(
  p_user_id UUID,
  p_amount INTEGER,
  p_type TEXT DEFAULT 'generation_deduction',
  p_metadata JSONB DEFAULT '{}'
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_current_balance INTEGER;
  v_new_transaction_id UUID;
BEGIN
  -- Lock user's transactions (prevents race conditions)
  SELECT COALESCE(SUM(amount), 0)
  INTO v_current_balance
  FROM credit_transactions
  WHERE user_id = p_user_id
  FOR UPDATE;

  -- Check sufficient balance
  IF v_current_balance < p_amount THEN
    RAISE EXCEPTION 'Insufficient credits: % available, % required', v_current_balance, p_amount;
  END IF;

  -- Insert deduction (negative amount)
  INSERT INTO credit_transactions (user_id, amount, type, metadata)
  VALUES (p_user_id, -p_amount, p_type, p_metadata)
  RETURNING id INTO v_new_transaction_id;

  RETURN jsonb_build_object(
    'success', TRUE,
    'transaction_id', v_new_transaction_id,
    'previous_balance', v_current_balance,
    'new_balance', v_current_balance - p_amount
  );
END;
$$;

GRANT EXECUTE ON FUNCTION deduct_credit TO authenticated;

-- Trigger to prevent negative balance
CREATE OR REPLACE FUNCTION check_balance_non_negative()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
  v_balance INTEGER;
BEGIN
  SELECT COALESCE(SUM(amount), 0)
  INTO v_balance
  FROM credit_transactions
  WHERE user_id = NEW.user_id;

  IF v_balance < 0 THEN
    RAISE EXCEPTION 'Balance cannot go negative';
  END IF;

  RETURN NEW;
END;
$$;

CREATE TRIGGER ensure_non_negative_balance
  AFTER INSERT ON credit_transactions
  FOR EACH ROW
  EXECUTE FUNCTION check_balance_non_negative();
```

Apply migration locally:
```bash
npx supabase db reset
```

Generate TypeScript types:
```bash
npx supabase gen types typescript --local > src/types/database.ts
```

Link to cloud project (using project ref from Supabase dashboard Settings > General):
```bash
npx supabase link --project-ref [your-project-ref]
```

Push migration to production:
```bash
npx supabase db push
```
  </action>
  <verify>
Run these checks:
1. `npx supabase db reset` - completes without errors
2. `cat src/types/database.ts` - contains CreditTransactions type
3. Query via Supabase SQL Editor:
   ```sql
   SELECT * FROM credit_transactions;
   ```
   Should return empty result (not permission error)
4. Test RPC function via SQL Editor:
   ```sql
   SELECT deduct_credit(
     auth.uid(),
     1,
     'generation_deduction',
     '{}'::jsonb
   );
   ```
   Should fail with "Insufficient credits" error (expected - no credits allocated yet)
  </verify>
  <done>
- Migration file exists and applies cleanly
- credit_transactions table exists in both local and production Supabase
- RLS is enabled on credit_transactions
- deduct_credit RPC function is callable
- src/types/database.ts generated with CreditTransactions type
- Balance cannot go negative (trigger enforces)
  </done>
</task>

</tasks>

<verification>
Complete foundation verification:

1. **Project runs:** `npm run dev` starts without errors, http://localhost:3000 accessible
2. **Database accessible:** Supabase dashboard shows credit_transactions table with RLS enabled
3. **Migrations work:** `npx supabase db reset` applies migrations cleanly
4. **Types generated:** src/types/database.ts contains schema types
5. **RPC callable:** deduct_credit function exists and enforces balance rules
</verification>

<success_criteria>
- Next.js 15 application scaffold complete with TypeScript and Tailwind CSS
- Supabase project created and linked (local + production)
- Database schema deployed with credit ledger pattern (INSERT-only transactions)
- RLS enabled on all tables before any data added
- TypeScript types generated from schema
- Migrations version controlled and reproducible
- Local development environment functional
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md`
</output>
