---
phase: 03-carousel-generation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(dashboard)/generate/actions.ts
  - src/app/api/generate/route.ts
  - src/app/api/webhooks/n8n/callback/route.ts
  - src/app/api/carousel/[id]/route.ts
  - src/lib/carousel/verify-webhook.ts
autonomous: true
requirements: [GEN-05, GEN-06, GEN-12, N8N-02, N8N-03, N8N-04, N8N-05, N8N-06]

must_haves:
  truths:
    - "Server action deducts 1 credit atomically before creating carousel job"
    - "Generation endpoint sends idea, template, style, and brand data to N8N webhook URL"
    - "N8N callback webhook verifies HMAC signature before processing"
    - "Callback updates carousel record from pending to completed with image URLs and post body"
    - "Status API endpoint returns current carousel status for polling"
  artifacts:
    - path: "src/app/(dashboard)/generate/actions.ts"
      provides: "Server action that deducts credit, creates carousel job, calls N8N"
      exports: ["initiateGeneration"]
    - path: "src/app/api/webhooks/n8n/callback/route.ts"
      provides: "Webhook receiver for N8N completion callbacks"
      exports: ["POST"]
    - path: "src/app/api/carousel/[id]/route.ts"
      provides: "Status polling endpoint for carousel job"
      exports: ["GET"]
    - path: "src/lib/carousel/verify-webhook.ts"
      provides: "HMAC SHA256 signature verification utility"
      exports: ["verifyWebhookSignature"]
  key_links:
    - from: "src/app/(dashboard)/generate/actions.ts"
      to: "deduct_credit RPC"
      via: "supabase.rpc('deduct_credit')"
      pattern: "rpc.*deduct_credit"
    - from: "src/app/(dashboard)/generate/actions.ts"
      to: "N8N webhook"
      via: "fetch(process.env.N8N_WEBHOOK_URL)"
      pattern: "N8N_WEBHOOK_URL"
    - from: "src/app/api/webhooks/n8n/callback/route.ts"
      to: "src/lib/carousel/verify-webhook.ts"
      via: "import verifyWebhookSignature"
      pattern: "verifyWebhookSignature"
    - from: "src/app/api/webhooks/n8n/callback/route.ts"
      to: "carousels table"
      via: "supabase.from('carousels').update()"
      pattern: "from.*carousels.*update"

user_setup:
  - service: n8n
    why: "Carousel generation workflow processing"
    env_vars:
      - name: N8N_WEBHOOK_URL
        source: "N8N instance -> Workflow -> Webhook trigger node -> Production URL"
      - name: N8N_WEBHOOK_SECRET
        source: "Generate a random secret (e.g., openssl rand -hex 32) and configure in both N8N and .env.local"
---

<objective>
Build the complete backend API layer for carousel generation: server action for initiating generation with atomic credit deduction, N8N webhook integration (outbound call + inbound callback), and status polling endpoint.

Purpose: This is the backbone that connects the user's generation request to N8N processing and back. Without this, no carousels can be generated. It handles the critical credit deduction, async job tracking, and secure webhook communication.

Output: Server action for generation, N8N callback webhook handler with HMAC verification, carousel status API endpoint, and webhook verification utility.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-carousel-generation/03-RESEARCH.md
@.planning/phases/03-carousel-generation/03-01-SUMMARY.md

@src/lib/supabase/server.ts
@src/app/(dashboard)/brand/actions.ts
@supabase/migrations/20260222145815_initial_schema.sql
@src/lib/validations/carousel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generation server action and N8N outbound webhook call</name>
  <files>
    src/app/(dashboard)/generate/actions.ts
    src/app/api/carousel/[id]/route.ts
  </files>
  <action>
1. Create `src/app/(dashboard)/generate/actions.ts` with `'use server'` directive:

**`initiateGeneration(prevState: any, formData: FormData)`** server action:
- Validate form data using GenerationSchema from `@/lib/validations/carousel`
- Get authenticated user via `createClient()` + `supabase.auth.getUser()`
- Return error if not authenticated
- Fetch brand profile from `brand_profiles` table for the user
- Return error if no brand profile or brand not completed (check for default values using same logic as `src/lib/brand/check-completion.ts`)
- Step 1: Call `supabase.rpc('deduct_credit', { p_user_id: user.id, p_amount: 1, p_type: 'generation_deduction', p_metadata: { action: 'carousel_generation' } })`
- If deduction fails, return `{ message: 'Insufficient credits. Please upgrade your plan.' }`
- Step 2: Insert carousel job into `carousels` table with status 'pending', all idea/template/style fields, and transaction_id from deduction result
- If insert fails, refund by inserting credit_transaction with amount 1, type 'refund', metadata `{ reason: 'job_creation_failed' }`
- Step 3: POST to `process.env.N8N_WEBHOOK_URL` with JSON body: `{ job_id, idea: { topic, key_points, tone }, template_url, image_style, brand: { name, primary_color, secondary_color, voice_guidelines, product_description, target_audience, cta_text } }`
- If N8N call fails, do NOT refund (job is created, N8N will retry or timeout handling kicks in)
- Return `{ success: true, job_id: carousel.id }`

2. Create `src/app/api/carousel/[id]/route.ts` with GET handler:
- Extract `id` from params
- Create Supabase server client
- Get authenticated user
- Query `carousels` table by id (RLS will enforce user ownership)
- Return JSON with `{ status, image_urls, post_body_text, error_message, created_at, completed_at }`
- Return 404 if not found
- Return 401 if not authenticated

Follow existing patterns from `src/app/(dashboard)/brand/actions.ts` for server action style.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `src/app/(dashboard)/generate/actions.ts` exports `initiateGeneration`
- Action calls `deduct_credit` RPC and inserts into `carousels` table
- Action calls N8N webhook URL with correct payload shape
- Status endpoint at `/api/carousel/[id]` returns carousel data
  </verify>
  <done>
- Generation server action atomically deducts credit, creates job, and calls N8N
- Refund logic handles failed job creation
- Status API endpoint enables frontend polling
- All data flows are type-safe with existing Supabase patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create N8N callback webhook handler with HMAC verification</name>
  <files>
    src/app/api/webhooks/n8n/callback/route.ts
    src/lib/carousel/verify-webhook.ts
  </files>
  <action>
1. Create `src/lib/carousel/verify-webhook.ts`:

**`verifyWebhookSignature(rawBody: string, signature: string, secret: string): boolean`**
- Use `crypto.createHmac('sha256', secret).update(rawBody).digest('hex')` to compute expected signature
- Use `crypto.timingSafeEqual()` to compare (constant-time comparison prevents timing attacks)
- Handle buffer length mismatch gracefully (return false, don't throw)
- Export as named function

2. Create `src/app/api/webhooks/n8n/callback/route.ts` with POST handler:

- Use `request.text()` to get raw body (CRITICAL: must use raw text for HMAC, not `.json()`)
- Get `x-n8n-signature` header
- If missing signature, return 401 `{ error: 'Missing signature' }`
- Call `verifyWebhookSignature(rawBody, signature, process.env.N8N_WEBHOOK_SECRET!)`
- If invalid signature, return 403 `{ error: 'Invalid signature' }`
- Parse raw body as JSON
- Validate payload with `N8nCallbackSchema` from `@/lib/validations/carousel`
- If validation fails, return 400 with errors
- Create Supabase admin client using `createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)` from `@supabase/supabase-js` directly (bypasses RLS since this is a server-to-server webhook)
- Update carousels table: SET status = payload.status (default 'completed'), image_urls = payload.image_urls, post_body_text = payload.post_body_text, completed_at = NOW()
- WHERE id = payload.job_id
- If update error, return 500
- If no rows updated (invalid job_id), return 404
- Return 200 `{ success: true }`
- Log all actions for debugging

**CRITICAL:** Do NOT use the server.ts createClient (that's for authenticated user requests). Use direct Supabase client with service role key for webhook handlers.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `src/lib/carousel/verify-webhook.ts` exports `verifyWebhookSignature`
- Webhook handler reads raw body, verifies HMAC, validates payload, updates database
- Uses service role key (not user session) for database operations
- Returns correct HTTP status codes (401, 403, 400, 404, 500, 200)
  </verify>
  <done>
- HMAC signature verification prevents unauthorized webhook calls
- Constant-time comparison prevents timing attacks
- Callback updates carousel status and stores image URLs + post body text
- Service role key bypasses RLS for server-to-server communication
- Payload validated with Zod schema before database operations
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with all new files
2. Generation action: deducts credit -> creates job -> calls N8N (in that order)
3. Callback webhook: verifies HMAC -> validates payload -> updates database
4. Status endpoint: returns carousel data with RLS enforcement
5. Refund logic: handles job creation failure with credit reversal
</verification>

<success_criteria>
- Credit deduction is atomic (uses existing deduct_credit RPC with FOR UPDATE lock)
- N8N receives all required data: idea, template, style, brand profile
- Webhook callback is secured with HMAC-SHA256 signature verification
- Carousel status transitions from pending to completed on successful callback
- Frontend can poll status via GET /api/carousel/[id]
</success_criteria>

<output>
After completion, create `.planning/phases/03-carousel-generation/03-02-SUMMARY.md`
</output>
