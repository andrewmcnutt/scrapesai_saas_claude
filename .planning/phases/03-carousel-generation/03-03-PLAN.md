---
phase: 03-carousel-generation
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/app/(dashboard)/generate/page.tsx
  - src/components/generation/GenerationWizard.tsx
  - src/components/generation/IdeaStep.tsx
  - src/components/generation/TemplateStep.tsx
  - src/components/generation/StyleStep.tsx
  - src/components/generation/StepIndicator.tsx
autonomous: true
requirements: [GEN-01, GEN-02, GEN-03, GEN-04, GEN-11, GEN-15]

must_haves:
  truths:
    - "User can input carousel idea with structured fields for topic, key points, and tone"
    - "User can select a template from a visual grid of 5-6 thumbnail previews"
    - "User can select an image style from visual style cards with previews"
    - "User can enter custom image style text when selecting the Custom option"
    - "Generate button is debounced to prevent double-click double-spend"
    - "Wizard progresses through 3 steps with validation at each step"
  artifacts:
    - path: "src/app/(dashboard)/generate/page.tsx"
      provides: "Generate page that renders the wizard"
      min_lines: 10
    - path: "src/components/generation/GenerationWizard.tsx"
      provides: "Multi-step form wrapper with state management"
      min_lines: 60
    - path: "src/components/generation/IdeaStep.tsx"
      provides: "Step 1: Topic, key points, and tone inputs"
      min_lines: 40
    - path: "src/components/generation/TemplateStep.tsx"
      provides: "Step 2: Visual template grid with selection state"
      min_lines: 40
    - path: "src/components/generation/StyleStep.tsx"
      provides: "Step 3: Style cards with custom option and Generate button"
      min_lines: 50
  key_links:
    - from: "src/components/generation/GenerationWizard.tsx"
      to: "src/app/(dashboard)/generate/actions.ts"
      via: "useActionState with initiateGeneration"
      pattern: "initiateGeneration"
    - from: "src/components/generation/GenerationWizard.tsx"
      to: "src/lib/validations/carousel.ts"
      via: "Zod step validation schemas"
      pattern: "IdeaStepSchema|TemplateStepSchema|StyleStepSchema"
    - from: "src/components/generation/TemplateStep.tsx"
      to: "src/lib/carousel/constants.ts"
      via: "import TEMPLATES constant"
      pattern: "TEMPLATES"
    - from: "src/components/generation/StyleStep.tsx"
      to: "src/lib/carousel/constants.ts"
      via: "import IMAGE_STYLES constant"
      pattern: "IMAGE_STYLES"
---

<objective>
Build the multi-step generation wizard UI with 3 steps: Idea input (topic, key points, tone), Template selection (visual grid), and Style selection (style cards with custom option). Includes step-by-step validation and debounced Generate button.

Purpose: This is the primary user interaction for creating carousels. The wizard guides non-designers through structured input so they don't need to figure out what information to provide. Per user decision: stepped wizard flow with each step shown one at a time.

Output: Complete generation wizard UI with 3 validated steps, integrated with server action for submission.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-carousel-generation/03-CONTEXT.md
@.planning/phases/03-carousel-generation/03-RESEARCH.md
@.planning/phases/03-carousel-generation/03-01-SUMMARY.md
@.planning/phases/03-carousel-generation/03-02-SUMMARY.md

@src/app/(dashboard)/layout.tsx
@src/app/(dashboard)/brand/brand-settings-form.tsx
@src/lib/carousel/constants.ts
@src/lib/validations/carousel.ts
@src/app/(dashboard)/generate/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generate page and wizard wrapper component</name>
  <files>
    src/app/(dashboard)/generate/page.tsx
    src/components/generation/GenerationWizard.tsx
    src/components/generation/StepIndicator.tsx
  </files>
  <action>
1. Create `src/app/(dashboard)/generate/page.tsx`:
- Server component that renders the page layout
- Title "Create Carousel" with subtitle "Follow the steps below to generate your branded carousel"
- Render `<GenerationWizard />` client component
- Clean, centered layout consistent with dashboard styling (gray-50 bg, white card container)

2. Create `src/components/generation/StepIndicator.tsx`:
- `'use client'` component
- Props: `steps: { id: string, label: string }[]`, `currentStep: number`
- Visual progress bar showing 3 steps with labels
- Completed steps show filled/blue state, current step shows active state, future steps show gray
- Use Tailwind classes: progress bar segments with rounded corners, step labels below

3. Create `src/components/generation/GenerationWizard.tsx`:
- `'use client'` component
- Import `initiateGeneration` from `@/app/(dashboard)/generate/actions`
- Import step validation schemas from `@/lib/validations/carousel`

**State management:**
- `currentStep`: 0 | 1 | 2 (idea, template, style)
- `formData`: `{ topic: '', keyPoints: '', tone: 'professional', templateUrl: '', imageStyle: '', customStyleText: '' }`
- `errors`: per-field error messages
- `isSubmitting`: boolean for debounce
- `result`: generation result (success/error/job_id)

**Step navigation:**
- `handleNext()`: Validate current step with appropriate Zod schema (IdeaStepSchema for step 0, TemplateStepSchema for step 1). If valid, advance to next step and clear errors. If invalid, show field errors.
- `handleBack()`: Go to previous step, preserve form data.

**Form submission (on final step):**
- Validate StyleStepSchema
- Set `isSubmitting = true` immediately (debounce per GEN-15)
- Build FormData object from state
- Call `initiateGeneration` via useActionState or direct call
- On success: redirect to `/carousel/{job_id}` (will show polling/completion UI)
- On error: show error message, set `isSubmitting = false`
- Use `useRouter` for navigation on success

**Regeneration support (GEN-11):**
- Accept optional `defaultValues` prop with pre-filled form data (topic, keyPoints, tone, templateUrl, imageStyle)
- If provided, skip to step 2 (template) or allow user to review from step 0
- Regeneration triggers same server action (costs another credit)

**Layout:**
- StepIndicator at top showing 3 steps: "Idea", "Template", "Style"
- Conditionally render IdeaStep, TemplateStep, or StyleStep based on currentStep
- Navigation buttons at bottom: "Back" (except step 0), "Next" (steps 0-1), "Generate" (step 2 only)
- Generate button shows loading state when isSubmitting, disabled to prevent double-click
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Generate page renders at `/generate` route
- Wizard manages 3 steps with forward/back navigation
- Step validation prevents advancing with invalid data
- Generate button is disabled during submission
  </verify>
  <done>
- Generate page exists in dashboard route group
- Wizard manages multi-step state with per-step validation
- Generate button debounced via disabled state during submission
- Navigation between steps preserves form data
  </done>
</task>

<task type="auto">
  <name>Task 2: Create wizard step components (Idea, Template, Style)</name>
  <files>
    src/components/generation/IdeaStep.tsx
    src/components/generation/TemplateStep.tsx
    src/components/generation/StyleStep.tsx
  </files>
  <action>
1. Create `src/components/generation/IdeaStep.tsx` (per user decision: "Structured fields: separate inputs for topic, key points, and tone"):
- `'use client'` component
- Props: `data`, `setData`, `errors`
- **Topic input:** `<input type="text">` with label "What's your carousel about?", placeholder "e.g., 5 productivity tips for remote workers", min 5 chars
- **Key Points textarea:** `<textarea>` with label "Key points to cover", placeholder "List the main points you want to include in your carousel. One per line.", min 10 chars, 4-5 rows
- **Tone selector:** Radio buttons or select for tone options: 'Professional', 'Casual', 'Inspirational', 'Educational', 'Conversational'. Style as clickable pill buttons.
- Show validation errors below each field in red text
- Clean form styling with labels, consistent with brand settings form patterns

2. Create `src/components/generation/TemplateStep.tsx` (per user decision: "Visual grid of 5-6 template preview thumbnails. User clicks a thumbnail to select"):
- `'use client'` component
- Props: `data`, `setData`, `errors`
- Import `TEMPLATES` from `@/lib/carousel/constants`
- Render 3x2 grid of template cards
- Each card: thumbnail image (use placeholder gray box with template name if thumbnail not available), template name below
- Selected template: highlighted border (e.g., ring-2 ring-blue-600), slight scale transform
- Click handler: `setData(prev => ({ ...prev, templateUrl: template.url }))`
- Show error if no template selected when trying to advance

3. Create `src/components/generation/StyleStep.tsx` (per user decision: "Style cards with visual preview for each of the 4 presets. 'Custom' option expands an input field"):
- `'use client'` component
- Props: `data`, `setData`, `errors`, `isSubmitting`
- Import `IMAGE_STYLES` from `@/lib/carousel/constants`
- Render style cards in a row/grid (2x3 or responsive)
- Each preset card: thumbnail preview area (placeholder with style name), style name, brief description
- Selected style: highlighted border (ring-2 ring-blue-600)
- **Custom option card:** When selected, expands a text input below the grid for user to type custom style description. Input has placeholder "Describe your desired image style..."
- If custom selected: `imageStyle` value = 'custom', store custom text separately in `customStyleText` field
- When submitting: if custom selected, use customStyleText as imageStyle value
- Show error if no style selected

All step components should follow consistent styling:
- Section title at top (e.g., "Describe Your Idea", "Choose a Template", "Select Image Style")
- Brief helper text below title
- Tailwind classes: white card backgrounds, rounded-lg, shadow-sm, proper spacing
  </action>
  <verify>
- `npx tsc --noEmit` passes
- IdeaStep renders topic input, key points textarea, and tone selector
- TemplateStep renders visual grid with selection highlighting
- StyleStep renders style cards with custom text expansion
- All steps pass data back to wizard via setData callback
- Error messages display correctly for invalid fields
  </verify>
  <done>
- Idea step has structured fields: topic, key points, and tone (per user decision, not free-form)
- Template step shows visual grid with highlighted selection state
- Style step shows 4 preset cards plus custom option with expandable text input
- All steps are self-contained client components with consistent styling
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/generate` in browser - wizard loads with Step 1
2. Step 1 validates: empty topic shows error, valid input allows Next
3. Step 2 shows template grid, clicking highlights selection
4. Step 3 shows style cards, custom option expands text input
5. Generate button disabled during submission (debounce)
6. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- 3-step wizard flow matches user decision: Idea -> Template -> Style -> Generate
- Each step validates before allowing progression
- Template grid shows 5-6 visual options with selection highlighting
- Style picker shows 4 presets plus custom with expandable input
- Generate button is debounced to prevent double-click
- Wizard integrates with initiateGeneration server action
</success_criteria>

<output>
After completion, create `.planning/phases/03-carousel-generation/03-03-SUMMARY.md`
</output>
