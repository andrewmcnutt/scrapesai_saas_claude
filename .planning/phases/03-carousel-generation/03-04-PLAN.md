---
phase: 03-carousel-generation
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/app/(dashboard)/carousel/[id]/page.tsx
  - src/components/carousel/CarouselViewer.tsx
  - src/components/carousel/GenerationPolling.tsx
  - src/components/carousel/SuccessScreen.tsx
  - src/lib/carousel/poll-status.ts
  - src/lib/carousel/download-zip.ts
autonomous: true
requirements: [GEN-07, GEN-08, GEN-09, GEN-10, GEN-12, GEN-13, UI-05]

must_haves:
  truths:
    - "User sees progress indicators during 60-180s generation processing"
    - "Polling uses exponential backoff at 2s, 4s, 8s intervals"
    - "Completed carousel displays all slides with slide-by-slide navigation"
    - "Post body text displays below the slide viewer"
    - "User can download all carousel images as a single ZIP file"
    - "Brief success screen appears before showing carousel slides"
  artifacts:
    - path: "src/app/(dashboard)/carousel/[id]/page.tsx"
      provides: "Carousel view page with polling, success, and viewer states"
      min_lines: 30
    - path: "src/components/carousel/CarouselViewer.tsx"
      provides: "Slide viewer with left/right nav and thumbnail strip"
      min_lines: 60
    - path: "src/components/carousel/GenerationPolling.tsx"
      provides: "Status polling with progress bar and messages"
      min_lines: 40
    - path: "src/lib/carousel/download-zip.ts"
      provides: "Client-side ZIP download using JSZip"
      exports: ["downloadCarouselZip"]
    - path: "src/lib/carousel/poll-status.ts"
      provides: "Exponential backoff polling utility"
      exports: ["pollCarouselStatus"]
  key_links:
    - from: "src/components/carousel/GenerationPolling.tsx"
      to: "src/lib/carousel/poll-status.ts"
      via: "import pollCarouselStatus"
      pattern: "pollCarouselStatus"
    - from: "src/components/carousel/GenerationPolling.tsx"
      to: "/api/carousel/[id]"
      via: "fetch status endpoint"
      pattern: "api/carousel"
    - from: "src/components/carousel/CarouselViewer.tsx"
      to: "src/lib/carousel/download-zip.ts"
      via: "import downloadCarouselZip for download button"
      pattern: "downloadCarouselZip"
---

<objective>
Build the carousel viewing experience: polling during generation, success screen on completion, slide-by-slide viewer with navigation and thumbnails, post body text display, and ZIP download.

Purpose: After the user submits the generation form, they're redirected to this page. It handles the 60-180s async wait with progress indicators, shows a brief success screen when complete, then displays the full carousel with navigation controls. This is where the user sees and downloads their generated content.

Output: Carousel page with 3 states (polling, success, viewing), slide navigation with thumbnails, post body text section, and ZIP download functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-carousel-generation/03-CONTEXT.md
@.planning/phases/03-carousel-generation/03-RESEARCH.md
@.planning/phases/03-carousel-generation/03-01-SUMMARY.md
@.planning/phases/03-carousel-generation/03-02-SUMMARY.md

@src/app/api/carousel/[id]/route.ts
@src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create polling utility, ZIP download, and polling UI component</name>
  <files>
    src/lib/carousel/poll-status.ts
    src/lib/carousel/download-zip.ts
    src/components/carousel/GenerationPolling.tsx
    src/components/carousel/SuccessScreen.tsx
  </files>
  <action>
1. Create `src/lib/carousel/poll-status.ts`:
- Import `backOff` from `exponential-backoff`
- Export `pollCarouselStatus(jobId: string, onProgress?: (attempt: number) => void): Promise<CarouselStatusResponse>`
- Fetch from `/api/carousel/${jobId}`
- If response status is 'completed' or 'failed' or 'timeout', return data (stops polling)
- If still 'pending' or 'processing', throw error to trigger retry
- Config: startingDelay 2000ms, timeMultiple 2, maxDelay 8000ms (caps at 8s per requirement GEN-13: 2s, 4s, 8s), numOfAttempts 40 (covers ~5 minutes)
- Call onProgress callback with attempt number on each retry
- On max attempts exceeded, return `{ status: 'timeout' }` (don't throw)

2. Create `src/lib/carousel/download-zip.ts`:
- Import JSZip from 'jszip'
- Export `downloadCarouselZip(imageUrls: string[], carouselName: string): Promise<void>`
- Fetch all images in parallel with `Promise.all`
- Add each image blob to zip as `slide-{index+1}.{extension}` (detect extension from URL, default to 'png')
- Generate zip blob with `zip.generateAsync({ type: 'blob' })`
- Create temporary anchor element, set href to ObjectURL, download attribute to `${carouselName}-carousel.zip`
- Click and revoke URL
- Handle fetch errors gracefully (skip failed images, log warning)

3. Create `src/components/carousel/GenerationPolling.tsx`:
- `'use client'` component
- Props: `jobId: string`, `onComplete: (data: any) => void`, `onError: (error: string) => void`
- Call `pollCarouselStatus` on mount via useEffect
- Display: centered spinner animation (CSS spin), "Generating your carousel..." heading
- Progress bar that fills based on poll attempt count (approximate progress)
- Helpful messages that rotate: "AI is crafting your slides...", "Applying your brand style...", "Almost there..."
- Text: "This typically takes 60-180 seconds. You can leave this page and check back later."
- On complete: call onComplete with carousel data
- On error/timeout: call onError with message

4. Create `src/components/carousel/SuccessScreen.tsx` (per user decision: "Brief success screen with View Carousel button"):
- `'use client'` component
- Props: `onViewCarousel: () => void`
- Displays checkmark icon, "Your carousel is ready!" heading
- "View Carousel" button that calls onViewCarousel
- Brief auto-transition: after 3 seconds, auto-click if user hasn't already (optional, Claude's discretion)
- Clean, celebratory but minimal design
  </action>
  <verify>
- `npx tsc --noEmit` passes
- poll-status.ts uses exponential-backoff library with correct intervals
- download-zip.ts uses JSZip for client-side ZIP generation
- GenerationPolling component displays progress and calls callbacks
- SuccessScreen shows completion message with action button
  </verify>
  <done>
- Polling utility handles exponential backoff at 2s, 4s, 8s intervals
- ZIP download generates client-side archive from image URLs
- Polling UI shows progress indicators during generation
- Success screen provides brief pause before viewing (per user decision)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create carousel viewer and carousel page</name>
  <files>
    src/app/(dashboard)/carousel/[id]/page.tsx
    src/components/carousel/CarouselViewer.tsx
  </files>
  <action>
1. Create `src/components/carousel/CarouselViewer.tsx` (per user decision: "Slide-by-slide view with left/right arrows, thumbnail strip below"):
- `'use client'` component
- Props: `imageUrls: string[]`, `postBodyText: string`, `carouselId: string`, `ideaTopic: string`, `onRegenerate?: () => void`

**Slide viewer section:**
- Large main image display area (responsive, max-width container)
- Left/right navigation arrows on sides of main image (chevron icons)
- Current slide number indicator (e.g., "3 / 8")
- Keyboard navigation: left/right arrow keys
- Use Swiper library for touch support and smooth transitions:
  - Import Swiper and SwiperSlide from 'swiper/react'
  - Import Navigation and Thumbs modules
  - Configure main swiper with navigation arrows
  - Use `thumbsSwiper` state to sync with thumbnail strip

**Thumbnail strip** (per user decision: "Thumbnail strip below the main slide viewer for jumping to specific slides"):
- Horizontal scrollable row of small slide thumbnails below main viewer
- Active thumbnail highlighted with border
- Click thumbnail to jump to that slide
- Use second Swiper instance as thumbs gallery:
  - slidesPerView: 'auto' or 5-8 depending on viewport
  - freeMode: true for scrollable behavior
  - watchSlidesProgress: true

**Post body text section** (per user decision: "Post body text in a section below the slide viewer, clearly separated"):
- Bordered section below thumbnail strip
- Label: "Post Body Text" or "LinkedIn Post"
- Display post body text with proper whitespace (whitespace-pre-wrap)
- Copy button to copy text to clipboard

**Action bar** (per user decision: "Download ZIP and Regenerate buttons in an action bar below"):
- Horizontal bar below post body text
- "Download ZIP" button: calls `downloadCarouselZip(imageUrls, ideaTopic)`
- "Regenerate" button: calls onRegenerate callback (navigates to /generate with same params)
- Show loading state on Download button while ZIP is being generated
- Style: primary button for Download, secondary/outline for Regenerate

Import Swiper CSS in the component or in a parent layout:
```
import 'swiper/css'
import 'swiper/css/navigation'
import 'swiper/css/thumbs'
```

2. Create `src/app/(dashboard)/carousel/[id]/page.tsx`:
- Server component that fetches initial carousel data
- Get carousel by `id` from Supabase (with auth check via RLS)
- If not found, show 404 / redirect
- If carousel.status is 'completed': render CarouselViewer directly (no polling needed for historical views)
- If carousel.status is 'pending' or 'processing': render client wrapper that handles polling flow

**Client wrapper component** (can be inline or separate):
- State machine with 3 phases: 'polling' | 'success' | 'viewing'
- Phase 'polling': render GenerationPolling, on complete transition to 'success'
- Phase 'success': render SuccessScreen, on "View Carousel" transition to 'viewing'
- Phase 'viewing': render CarouselViewer with data from polling result
- Phase transitions: polling -> success -> viewing
- If carousel.status is 'failed' or 'timeout': show error state with message and "Back to Dashboard" link

**Regenerate flow:**
- onRegenerate: navigate to `/generate?topic=${encoded}&keyPoints=${encoded}&tone=${encoded}&templateUrl=${encoded}&imageStyle=${encoded}`
- Generation wizard will read URL params as default values (handled in Plan 03)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Carousel page at `/carousel/[id]` renders correctly
- Pending carousels show polling UI, completed show viewer directly
- CarouselViewer has slide navigation with arrows and thumbnail strip
- Post body text displays below slides
- Download ZIP and Regenerate buttons work
- Swiper library integrated for touch/keyboard navigation
  </verify>
  <done>
- Carousel page handles all status states: pending (polling), success (brief screen), completed (viewer), failed/timeout (error)
- Slide viewer uses Swiper for professional navigation with thumbnail sync
- Post body text clearly separated below viewer
- ZIP download generates client-side from image URLs
- Regenerate button navigates back to wizard with pre-filled data
  </done>
</task>

</tasks>

<verification>
1. `/carousel/[id]` with pending carousel shows polling with progress
2. Polling transitions through success screen to viewer
3. Completed carousel shows slide viewer with navigation arrows
4. Thumbnail strip syncs with main slide viewer
5. Post body text displays below slides
6. Download ZIP button generates and downloads zip file
7. Regenerate button navigates to generation wizard
</verification>

<success_criteria>
- Async generation (60-180s) handled with progress indicators and exponential backoff polling
- Carousel viewer shows slides with left/right navigation and thumbnail strip
- Post body text clearly displayed below slides
- ZIP download works client-side with JSZip
- Success screen provides brief pause before viewing (per user decision)
- All 3 page states (polling, success, viewing) transition correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-carousel-generation/03-04-SUMMARY.md`
</output>
