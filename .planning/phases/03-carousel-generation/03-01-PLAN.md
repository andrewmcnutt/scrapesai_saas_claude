---
phase: 03-carousel-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260222_carousels.sql
  - src/types/database.ts
  - src/lib/validations/carousel.ts
  - src/lib/carousel/constants.ts
  - .env.example
  - package.json
autonomous: true
requirements: [GEN-02, GEN-03, GEN-06, HIST-01, HIST-03, N8N-01]

must_haves:
  truths:
    - "Carousels table exists with all required columns for generation params, results, and status tracking"
    - "TypeScript types are available for type-safe carousel database operations"
    - "Zod validation schemas exist for generation form input"
    - "Template and style constants are defined as reusable data"
    - "JSZip, Swiper, and exponential-backoff packages are installed"
  artifacts:
    - path: "supabase/migrations/20260222_carousels.sql"
      provides: "Carousels table with RLS, indexes, and refund function"
      contains: "CREATE TABLE carousels"
    - path: "src/types/database.ts"
      provides: "Carousel TypeScript types added to existing Database type"
      contains: "carousels"
    - path: "src/lib/validations/carousel.ts"
      provides: "Zod schemas for generation form validation"
      contains: "GenerationSchema"
    - path: "src/lib/carousel/constants.ts"
      provides: "Template URLs and style preset definitions"
      contains: "TEMPLATES"
  key_links:
    - from: "src/types/database.ts"
      to: "supabase/migrations/20260222_carousels.sql"
      via: "TypeScript types match migration columns"
      pattern: "carousels.*Row"
    - from: "src/lib/validations/carousel.ts"
      to: "src/types/database.ts"
      via: "Zod schema fields match database column types"
      pattern: "z\\.string|z\\.enum"
---

<objective>
Create the database foundation and shared dependencies for carousel generation.

Purpose: All subsequent plans depend on the carousels table schema, TypeScript types, validation schemas, and npm packages. This plan establishes the data layer that generation, viewing, history, and refund features all build on.

Output: Database migration for carousels table, updated TypeScript types, Zod validation schemas, template/style constants, installed npm dependencies, and updated .env.example with N8N variables.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-carousel-generation/03-RESEARCH.md

@supabase/migrations/20260222145815_initial_schema.sql
@supabase/migrations/20260222_brand_profiles.sql
@src/types/database.ts
@src/lib/validations/brand.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create carousels database migration and install npm dependencies</name>
  <files>
    supabase/migrations/20260222_carousels.sql
    src/lib/carousel/constants.ts
    .env.example
    package.json
  </files>
  <action>
1. Run `npm install jszip swiper exponential-backoff` to add Phase 3 dependencies.

2. Create `supabase/migrations/20260222_carousels.sql` with:

**Table `carousels`:**
- `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
- `user_id` UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
- `status` TEXT NOT NULL CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'timeout'))
- `idea_topic` TEXT NOT NULL
- `idea_key_points` TEXT NOT NULL
- `idea_tone` TEXT NOT NULL
- `template_url` TEXT NOT NULL
- `image_style` TEXT NOT NULL
- `image_urls` TEXT[] (nullable, populated on completion)
- `post_body_text` TEXT (nullable, populated on completion)
- `transaction_id` UUID REFERENCES credit_transactions(id) (links to credit deduction)
- `error_message` TEXT (nullable, populated on failure)
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT NOW()
- `completed_at` TIMESTAMPTZ (nullable)

**Indexes:**
- `idx_carousels_user_id_created_at` ON carousels(user_id, created_at DESC) for history queries
- `idx_carousels_pending_timeout` ON carousels(status, created_at) WHERE status = 'pending' for timeout detection

**RLS policies** (follow existing pattern from brand_profiles using `(SELECT auth.uid()) = user_id`):
- SELECT policy: "Users can view own carousels" TO authenticated
- INSERT policy: "Users can insert own carousels" TO authenticated WITH CHECK

**No UPDATE policy for authenticated users** -- updates come from webhook handler using service role key (bypasses RLS).

**Function `refund_timeout_jobs()`:**
- SECURITY DEFINER, LANGUAGE plpgsql
- Find carousels WHERE status = 'pending' AND created_at < NOW() - INTERVAL '5 minutes'
- UPDATE those to status = 'timeout', error_message = 'Generation timed out after 5 minutes'
- INSERT refund transactions (amount = 1, type = 'refund', metadata includes carousel_id and reason 'timeout')
- UPDATE completed_at = NOW() to prevent duplicate refunds
- GRANT EXECUTE to authenticated (will be called via RPC or scheduled job)

3. Create `src/lib/carousel/constants.ts` with:
- `TEMPLATES` array: 5-6 objects with `{ id, name, url, thumbnailUrl }`. Use placeholder URLs for now (e.g., `/templates/template-1.png` for thumbnails, actual template URLs TBD from external source). Include ids like 'professional-grid', 'bold-statement', 'story-arc', 'data-driven', 'tips-listicle', 'case-study'.
- `IMAGE_STYLES` array: 4 preset objects `{ id, name, description, thumbnailUrl }` for 'Technical Annotation', 'Realism Notebook', 'White Board Diagram', 'Comic Strip Storyboard'. Include a 5th entry for 'custom' with id 'custom'.
- `CAROUSEL_STATUS` const object mapping status strings for type safety.
- `MAX_POLL_TIMEOUT_MS = 300000` (5 minutes)
- `POLL_STARTING_DELAY_MS = 2000`

4. Update `.env.example` to add N8N-related environment variables:
```
N8N_WEBHOOK_URL=https://your-n8n-instance.com/webhook/carousel-generate
N8N_WEBHOOK_SECRET=your-n8n-webhook-secret-for-hmac
```
  </action>
  <verify>
- `npm ls jszip swiper exponential-backoff` shows all three installed
- Migration file exists at `supabase/migrations/20260222_carousels.sql`
- Migration contains CREATE TABLE, RLS policies, indexes, and refund_timeout_jobs function
- Constants file exports TEMPLATES, IMAGE_STYLES, CAROUSEL_STATUS
- `.env.example` contains N8N_WEBHOOK_URL and N8N_WEBHOOK_SECRET
  </verify>
  <done>
- All 3 npm packages installed
- Carousels migration ready with table, RLS, indexes, and timeout refund function
- Template and style constants defined for UI consumption
- Env vars documented for N8N integration
  </done>
</task>

<task type="auto">
  <name>Task 2: Create carousel TypeScript types and Zod validation schemas</name>
  <files>
    src/types/database.ts
    src/lib/validations/carousel.ts
  </files>
  <action>
1. Update `src/types/database.ts` to add `carousels` table to the existing Database type (alongside brand_profiles and credit_transactions):

```typescript
carousels: {
  Row: {
    id: string
    user_id: string
    status: 'pending' | 'processing' | 'completed' | 'failed' | 'timeout'
    idea_topic: string
    idea_key_points: string
    idea_tone: string
    template_url: string
    image_style: string
    image_urls: string[] | null
    post_body_text: string | null
    transaction_id: string | null
    error_message: string | null
    created_at: string
    completed_at: string | null
  }
  Insert: {
    id?: string
    user_id: string
    status: 'pending' | 'processing' | 'completed' | 'failed' | 'timeout'
    idea_topic: string
    idea_key_points: string
    idea_tone: string
    template_url: string
    image_style: string
    image_urls?: string[] | null
    post_body_text?: string | null
    transaction_id?: string | null
    error_message?: string | null
    created_at?: string
    completed_at?: string | null
  }
  Update: {
    // All fields optional
    id?: string
    user_id?: string
    status?: 'pending' | 'processing' | 'completed' | 'failed' | 'timeout'
    idea_topic?: string
    idea_key_points?: string
    idea_tone?: string
    template_url?: string
    image_style?: string
    image_urls?: string[] | null
    post_body_text?: string | null
    transaction_id?: string | null
    error_message?: string | null
    created_at?: string
    completed_at?: string | null
  }
  Relationships: [
    {
      foreignKeyName: "carousels_user_id_fkey"
      columns: ["user_id"]
      isOneToOne: false
      referencedRelation: "users"
      referencedColumns: ["id"]
    },
    {
      foreignKeyName: "carousels_transaction_id_fkey"
      columns: ["transaction_id"]
      isOneToOne: false
      referencedRelation: "credit_transactions"
      referencedColumns: ["id"]
    }
  ]
}
```

Also add `refund_timeout_jobs` to the Functions section:
```typescript
refund_timeout_jobs: {
  Args: Record<string, never>
  Returns: undefined
}
```

2. Create `src/lib/validations/carousel.ts` with Zod schemas:

**GenerationSchema** - validates the full generation form submission:
- `topic`: z.string().min(5, 'Topic must be at least 5 characters').max(200)
- `keyPoints`: z.string().min(10, 'Key points must be at least 10 characters').max(1000)
- `tone`: z.string().min(1, 'Please select a tone')
- `templateUrl`: z.string().url('Please select a valid template')
- `imageStyle`: z.string().min(1, 'Please select an image style')

**IdeaStepSchema** - validates just the first wizard step (topic, keyPoints, tone).

**TemplateStepSchema** - validates just the template step (templateUrl).

**StyleStepSchema** - validates just the style step (imageStyle).

**N8nCallbackSchema** - validates the webhook callback payload:
- `job_id`: z.string().uuid()
- `image_urls`: z.array(z.string().url()).min(1).max(15)
- `post_body_text`: z.string().min(1)
- `status`: z.enum(['completed', 'failed']).optional().default('completed')

Follow same patterns as `src/lib/validations/brand.ts` (import style, export style).
  </action>
  <verify>
- `npx tsc --noEmit` passes with no errors
- `src/types/database.ts` contains carousels table types
- `src/lib/validations/carousel.ts` exports GenerationSchema, IdeaStepSchema, TemplateStepSchema, StyleStepSchema, N8nCallbackSchema
  </verify>
  <done>
- Database types include carousels with all columns matching migration
- Zod schemas provide per-step and full-form validation for wizard
- N8N callback payload validated via schema
- TypeScript compilation passes
  </done>
</task>

</tasks>

<verification>
1. `npm ls jszip swiper exponential-backoff` confirms all packages installed
2. Migration file has complete schema (table + indexes + RLS + refund function)
3. TypeScript types match migration columns exactly
4. Zod schemas cover all wizard steps plus callback payload
5. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Carousels database table schema is complete with RLS and timeout refund
- TypeScript types for carousel operations are type-safe
- Zod validation covers all form inputs and webhook payload
- Template and style constants are available for UI components
- All npm dependencies are installed
- N8N env vars documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/03-carousel-generation/03-01-SUMMARY.md`
</output>
