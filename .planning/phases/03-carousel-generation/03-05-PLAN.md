---
phase: 03-carousel-generation
plan: 05
type: execute
wave: 4
depends_on: ["03-04"]
files_modified:
  - src/app/(dashboard)/history/page.tsx
  - src/components/history/HistoryList.tsx
  - src/components/history/HistoryCard.tsx
  - src/components/history/Pagination.tsx
autonomous: true
requirements: [HIST-01, HIST-02, HIST-03, HIST-04, HIST-05, HIST-06]

must_haves:
  truths:
    - "User can view history page showing all past carousels"
    - "History displays original idea, template, style, and timestamp for each carousel"
    - "User can click a history entry to view the full carousel with slides and post body"
    - "User can download historical carousels as ZIP from history"
    - "History is paginated with 20 items per page"
  artifacts:
    - path: "src/app/(dashboard)/history/page.tsx"
      provides: "History page with server-side data fetching and pagination"
      min_lines: 30
    - path: "src/components/history/HistoryList.tsx"
      provides: "List/grid of historical carousel entries"
      min_lines: 30
    - path: "src/components/history/HistoryCard.tsx"
      provides: "Individual history entry card with metadata"
      min_lines: 30
    - path: "src/components/history/Pagination.tsx"
      provides: "Page-based pagination controls"
      min_lines: 20
  key_links:
    - from: "src/app/(dashboard)/history/page.tsx"
      to: "carousels table"
      via: "supabase.from('carousels').select()"
      pattern: "from.*carousels.*select"
    - from: "src/components/history/HistoryCard.tsx"
      to: "/carousel/[id]"
      via: "Link to carousel detail page"
      pattern: "carousel/"
    - from: "src/components/history/HistoryCard.tsx"
      to: "src/lib/carousel/download-zip.ts"
      via: "Download button for completed carousels"
      pattern: "downloadCarouselZip"
---

<objective>
Build the carousel history page with paginated list of past generations, showing metadata for each carousel and providing navigation to view and download historical carousels.

Purpose: Users need to access all previously generated carousels. The history page is the central place to browse, review, and re-download past work. Per Claude's discretion: card grid layout with traditional pagination (20 per page).

Output: History page with paginated carousel cards, each showing idea summary, template, style, timestamp, status, and quick actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-carousel-generation/03-CONTEXT.md
@.planning/phases/03-carousel-generation/03-04-SUMMARY.md

@src/app/(dashboard)/layout.tsx
@src/app/(dashboard)/carousel/[id]/page.tsx
@src/lib/carousel/download-zip.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create history page with server-side data fetching</name>
  <files>
    src/app/(dashboard)/history/page.tsx
    src/components/history/Pagination.tsx
  </files>
  <action>
1. Create `src/app/(dashboard)/history/page.tsx`:
- Server component
- Accept `searchParams` for page number: `?page=1` (default to 1)
- Create Supabase server client, get authenticated user
- Query carousels table: select all columns, filter by user_id (RLS handles this), order by created_at DESC
- Use Supabase `.range()` for pagination: page size = 20, calculate offset from page number
- Also get total count via separate `.select('*', { count: 'exact', head: true })` query
- Calculate total pages from count
- Pass data to HistoryList component

**Page layout:**
- Title: "Carousel History"
- Subtitle: "{totalCount} carousels generated"
- If no carousels: show empty state ("No carousels yet. Create your first one!" with link to /generate)
- Render HistoryList with carousel data
- Render Pagination at bottom

2. Create `src/components/history/Pagination.tsx`:
- Server or client component (server is fine for simple page links)
- Props: `currentPage: number`, `totalPages: number`
- Render page numbers with Previous/Next buttons
- Use `<Link>` components pointing to `/history?page={n}`
- Active page highlighted (blue bg, white text)
- Disable Previous on page 1, disable Next on last page
- Show max 5 page numbers with ellipsis for large result sets
- Clean, minimal styling with Tailwind
  </action>
  <verify>
- `npx tsc --noEmit` passes
- History page loads at `/history`
- Pagination renders with correct page count
- Empty state shows when no carousels exist
- Page navigation works via URL params
  </verify>
  <done>
- History page fetches paginated carousel data from Supabase with RLS
- Pagination component supports page-based navigation with 20 items per page
- Empty state guides user to create first carousel
  </done>
</task>

<task type="auto">
  <name>Task 2: Create history list and card components</name>
  <files>
    src/components/history/HistoryList.tsx
    src/components/history/HistoryCard.tsx
  </files>
  <action>
1. Create `src/components/history/HistoryList.tsx`:
- Props: `carousels: CarouselRow[]` (use type from database.ts)
- Render responsive grid of HistoryCard components
- Grid: 1 column on mobile, 2 on md, 3 on lg
- Gap between cards for clean spacing

2. Create `src/components/history/HistoryCard.tsx`:
- `'use client'` component (needs download button interactivity)
- Props: single carousel object from database

**Card content:**
- Thumbnail: First image from `image_urls` array (if completed), or placeholder gray area with status badge (if pending/failed)
- Status badge: colored pill showing status (green for completed, yellow for pending, red for failed/timeout)
- Idea topic as card title (truncated to 2 lines)
- Metadata row: template name (derive from URL or store), image style, date (formatted as relative time or "Feb 22, 2026")
- Created timestamp formatted with Intl.DateTimeFormat

**Actions:**
- "View" link: navigates to `/carousel/{id}` (uses Next.js Link)
- "Download" button (only for completed carousels): calls `downloadCarouselZip(carousel.image_urls, carousel.idea_topic)`
- Download button shows loading spinner while generating ZIP
- For failed/timeout carousels: show error_message in muted text

**Styling:**
- White card with rounded corners, subtle shadow
- Hover state: slight shadow increase
- Consistent with dashboard design language
- Responsive: card adapts to grid column width
  </action>
  <verify>
- `npx tsc --noEmit` passes
- HistoryCard displays carousel metadata (topic, template, style, timestamp)
- Completed carousels show thumbnail and download button
- Pending/failed carousels show appropriate status indicators
- View link navigates to carousel detail page
- Download button generates ZIP via JSZip
  </verify>
  <done>
- History list renders grid of carousel cards
- Each card shows idea topic, status, style, timestamp (HIST-03)
- View button navigates to carousel detail page (HIST-04)
- Download button generates ZIP for completed carousels (HIST-05)
- Cards handle all carousel statuses (pending, completed, failed, timeout)
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/history` - shows carousel history or empty state
2. Cards display idea topic, template, style, timestamp, and status
3. Click "View" navigates to `/carousel/[id]` detail page
4. Click "Download" generates and downloads ZIP file
5. Pagination navigates between pages correctly
6. RLS ensures users only see their own carousels
</verification>

<success_criteria>
- All generated carousels appear in history (auto-saved by generation process, HIST-01)
- History shows idea, template, style, and timestamp for each entry (HIST-03)
- User can view any historical carousel with full slides and post body (HIST-04)
- User can download historical carousels as ZIP (HIST-05)
- History is paginated with 20 items per page (HIST-06)
</success_criteria>

<output>
After completion, create `.planning/phases/03-carousel-generation/03-05-SUMMARY.md`
</output>
