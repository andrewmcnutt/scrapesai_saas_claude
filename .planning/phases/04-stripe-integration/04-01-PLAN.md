---
phase: 04-stripe-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/stripe/client.ts
  - src/lib/stripe/types.ts
  - supabase/migrations/20260225_stripe_integration.sql
  - .env.example
autonomous: true
requirements:
  - INFRA-04
  - CRED-09
user_setup:
  - service: stripe
    why: "Payment processing — Stripe account required for API keys and webhook configuration"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (sk_live_... or sk_test_...)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint -> Signing secret (whsec_...)"
      - name: STRIPE_PRICE_ID
        source: "Stripe Dashboard -> Products -> Create product ($29.99/month) -> Copy Price ID (price_...)"
      - name: NEXT_PUBLIC_APP_URL
        source: "Your production domain (e.g., https://yourdomain.com) or http://localhost:3000 for dev"
    dashboard_config:
      - task: "Create product with $29.99/month recurring price"
        location: "Stripe Dashboard -> Products -> Add product"
      - task: "Add webhook endpoint pointing to {NEXT_PUBLIC_APP_URL}/api/webhooks/stripe"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"
      - task: "Select events: customer.subscription.created, customer.subscription.updated, customer.subscription.deleted, invoice.paid, invoice.payment_failed"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Events to send"
      - task: "Enable Customer Portal"
        location: "Stripe Dashboard -> Settings -> Billing -> Customer portal -> Activate link"

must_haves:
  truths:
    - "Stripe SDK is installed and configured as a singleton for server-side use"
    - "Database has subscriptions table with RLS allowing users to read own subscription"
    - "Database has stripe_processed_events table for webhook idempotency"
    - "Environment variables for Stripe are documented in .env.example"
  artifacts:
    - path: "src/lib/stripe/client.ts"
      provides: "Stripe singleton instance"
      contains: "new Stripe"
    - path: "src/lib/stripe/types.ts"
      provides: "Subscription and tier type definitions"
      contains: "SubscriptionStatus"
    - path: "supabase/migrations/20260225_stripe_integration.sql"
      provides: "subscriptions + stripe_processed_events tables"
      contains: "CREATE TABLE subscriptions"
    - path: ".env.example"
      provides: "Stripe env var documentation"
      contains: "STRIPE_SECRET_KEY"
  key_links:
    - from: "src/lib/stripe/client.ts"
      to: "process.env.STRIPE_SECRET_KEY"
      via: "environment variable"
      pattern: "process\\.env\\.STRIPE_SECRET_KEY"
    - from: "supabase/migrations/20260225_stripe_integration.sql"
      to: "auth.users"
      via: "foreign key on subscriptions.user_id"
      pattern: "REFERENCES auth\\.users"
---

<objective>
Install Stripe SDK, create database schema for subscriptions and webhook idempotency, and establish TypeScript types for the Stripe integration layer.

Purpose: Foundation for all Stripe integration — webhook handler, checkout, and billing UI all depend on these tables, types, and the Stripe client singleton.
Output: stripe npm package installed, Stripe client module, TypeScript types, SQL migration file, updated .env.example
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-stripe-integration/04-RESEARCH.md
@supabase/migrations/20260222145815_initial_schema.sql
@src/lib/supabase/server.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe SDK and create client singleton + types</name>
  <files>
    src/lib/stripe/client.ts
    src/lib/stripe/types.ts
    .env.example
  </files>
  <action>
    1. Run `npm install stripe` to install the Stripe Node.js SDK (v20.x).

    2. Create `src/lib/stripe/client.ts`:
       - Import Stripe from 'stripe'
       - Export a singleton: `export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, { apiVersion: '2024-11-20', typescript: true })`
       - This is server-side only — no 'use client' directive

    3. Create `src/lib/stripe/types.ts` with TypeScript types:
       - `SubscriptionStatus` type: 'active' | 'past_due' | 'canceled' | 'incomplete' | 'incomplete_expired' | 'trialing' | 'unpaid' | 'paused'
       - `UserSubscription` interface: { id: string, userId: string, stripeSubscriptionId: string, stripeCustomerId: string, stripePriceId: string, status: SubscriptionStatus, currentPeriodStart: string | null, currentPeriodEnd: string | null, cancelAtPeriodEnd: boolean, canceledAt: string | null }
       - `UserTier` type: 'free' | 'paid'
       - `UserSubscriptionStatus` interface: { balance: number, isActiveSub: boolean, isFree: boolean, tier: UserTier, cancelAtPeriodEnd: boolean, currentPeriodEnd: string | null }

    4. Update `.env.example` — append Stripe env vars:
       ```
       STRIPE_SECRET_KEY=sk_test_your-stripe-secret-key
       STRIPE_WEBHOOK_SECRET=whsec_your-stripe-webhook-secret
       STRIPE_PRICE_ID=price_your-stripe-price-id
       NEXT_PUBLIC_APP_URL=http://localhost:3000
       ```
  </action>
  <verify>
    - `npm ls stripe` shows stripe installed
    - `npx tsc --noEmit src/lib/stripe/client.ts` compiles without errors
    - `.env.example` contains all 4 Stripe env vars
  </verify>
  <done>
    Stripe SDK installed, singleton client exported, TypeScript types defined, env vars documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database migration for subscriptions and stripe_processed_events tables</name>
  <files>
    supabase/migrations/20260225_stripe_integration.sql
  </files>
  <action>
    Create `supabase/migrations/20260225_stripe_integration.sql` with:

    1. **subscriptions table:**
       ```sql
       CREATE TABLE subscriptions (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
         stripe_subscription_id TEXT NOT NULL UNIQUE,
         stripe_customer_id TEXT NOT NULL,
         stripe_price_id TEXT NOT NULL,
         status TEXT NOT NULL CHECK (status IN ('active', 'past_due', 'canceled', 'incomplete', 'incomplete_expired', 'trialing', 'unpaid', 'paused')),
         current_period_start TIMESTAMPTZ,
         current_period_end TIMESTAMPTZ,
         cancel_at_period_end BOOLEAN NOT NULL DEFAULT FALSE,
         canceled_at TIMESTAMPTZ,
         created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
         updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
       );
       ```
       - Add indexes: `idx_subscriptions_user_id` on user_id, `idx_subscriptions_stripe_customer_id` on stripe_customer_id
       - Enable RLS
       - Add SELECT policy: "Users can view own subscription" for authenticated users WHERE auth.uid() = user_id
       - NO INSERT/UPDATE/DELETE policies — all writes via service role key from webhook handler

    2. **stripe_processed_events table:**
       ```sql
       CREATE TABLE stripe_processed_events (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         stripe_event_id TEXT NOT NULL UNIQUE,
         event_type TEXT NOT NULL,
         processed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
       );
       ```
       - Enable RLS with NO policies (service role only — not user-accessible)
       - Add comment: "No RLS policies: internal webhook processing table, service role access only"

    3. **updated_at trigger** for subscriptions:
       ```sql
       CREATE OR REPLACE FUNCTION update_updated_at_column()
       RETURNS TRIGGER AS $$
       BEGIN
         NEW.updated_at = NOW();
         RETURN NEW;
       END;
       $$ LANGUAGE plpgsql;

       CREATE TRIGGER set_subscriptions_updated_at
         BEFORE UPDATE ON subscriptions
         FOR EACH ROW
         EXECUTE FUNCTION update_updated_at_column();
       ```
       Note: Check if `update_updated_at_column` already exists from a prior migration. If so, just create the trigger, not the function.

    This migration must be applied manually via Supabase SQL Editor (consistent with Phase 1 pattern — webhook not triggered).
  </action>
  <verify>
    - File exists at `supabase/migrations/20260225_stripe_integration.sql`
    - SQL syntax is valid (no obvious errors)
    - Contains both CREATE TABLE statements
    - Contains RLS ENABLE on both tables
    - Contains SELECT policy for subscriptions
    - Contains indexes on user_id and stripe_customer_id
  </verify>
  <done>
    Migration file creates subscriptions table with RLS, stripe_processed_events table, indexes, and updated_at trigger. Ready for manual application via Supabase SQL Editor.
  </done>
</task>

</tasks>

<verification>
- `npm ls stripe` confirms stripe package installed
- TypeScript compilation passes for new files
- Migration SQL file is syntactically valid
- .env.example has all required Stripe env vars
- No existing files broken (run `npm run build` quick check)
</verification>

<success_criteria>
- stripe npm package is installed and importable
- Stripe client singleton exports correctly
- TypeScript types defined for subscription data
- SQL migration file ready for manual application
- .env.example documents all required Stripe environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/04-stripe-integration/04-01-SUMMARY.md`
</output>
