---
phase: 04-stripe-integration
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - src/lib/stripe/actions.ts
  - src/app/(dashboard)/billing/page.tsx
  - src/app/(dashboard)/billing/success/page.tsx
autonomous: true
requirements:
  - PAY-02
  - PAY-03
  - PAY-11
  - PAY-12

must_haves:
  truths:
    - "User can initiate Stripe Checkout subscription flow from the billing page"
    - "Checkout session is created server-side with user_id in both session and subscription metadata"
    - "Success page queries Stripe API directly to confirm payment status (handles webhook race condition)"
    - "User can access Stripe Customer Portal to manage their subscription"
    - "Existing Stripe customers are reused (no duplicate customer creation)"
  artifacts:
    - path: "src/lib/stripe/actions.ts"
      provides: "Server Actions for checkout and portal session creation"
      exports: ["createCheckoutSession", "createPortalSession"]
    - path: "src/app/(dashboard)/billing/page.tsx"
      provides: "Billing management page with subscribe and manage buttons"
      min_lines: 30
    - path: "src/app/(dashboard)/billing/success/page.tsx"
      provides: "Post-checkout success page that syncs with Stripe"
      min_lines: 30
  key_links:
    - from: "src/lib/stripe/actions.ts"
      to: "stripe.checkout.sessions.create"
      via: "Server Action -> Stripe API"
      pattern: "stripe\\.checkout\\.sessions\\.create"
    - from: "src/lib/stripe/actions.ts"
      to: "stripe.billingPortal.sessions.create"
      via: "Server Action -> Stripe Portal API"
      pattern: "stripe\\.billingPortal\\.sessions\\.create"
    - from: "src/app/(dashboard)/billing/success/page.tsx"
      to: "stripe.checkout.sessions.retrieve"
      via: "Direct Stripe query for payment confirmation"
      pattern: "stripe\\.checkout\\.sessions\\.retrieve"
---

<objective>
Create Stripe Checkout subscription flow, post-checkout success page with direct Stripe sync, billing management page, and Customer Portal access.

Purpose: Users need to be able to subscribe ($29.99/month), see their subscription activated immediately after checkout, and manage their subscription (cancel, update payment method) via Stripe's hosted portal.
Output: Two Server Actions (checkout + portal), billing page, and success page
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-stripe-integration/04-RESEARCH.md
@.planning/phases/04-stripe-integration/04-01-SUMMARY.md
@src/lib/stripe/client.ts
@src/lib/stripe/types.ts
@src/lib/supabase/server.ts
@src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Actions for Stripe Checkout and Customer Portal</name>
  <files>
    src/lib/stripe/actions.ts
  </files>
  <action>
    Create `src/lib/stripe/actions.ts` with 'use server' directive:

    1. **createCheckoutSession():**
       - Get authenticated user via Supabase `createClient()` -> `auth.getUser()`
       - If no user, redirect to '/login'
       - Check if user already has a Stripe customer ID by querying `subscriptions` table for user_id, selecting `stripe_customer_id` with `.maybeSingle()`
       - Create checkout session via `stripe.checkout.sessions.create()`:
         - mode: 'subscription'
         - payment_method_types: ['card']
         - line_items: [{ price: process.env.STRIPE_PRICE_ID!, quantity: 1 }]
         - success_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success?session_id={CHECKOUT_SESSION_ID}`
         - cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard`
         - customer: existingSub?.stripe_customer_id ?? undefined (reuse existing Stripe customer)
         - customer_email: existingSub?.stripe_customer_id ? undefined : user.email (only set if no existing customer)
         - metadata: { user_id: user.id } — CRITICAL for webhook to link subscription to user
         - subscription_data: { metadata: { user_id: user.id } } — Also on subscription object for subscription events
       - Call `redirect(session.url!)` — Server Action redirect

    2. **createPortalSession():**
       - Get authenticated user via Supabase
       - If no user, redirect to '/login'
       - Query subscriptions table for stripe_customer_id where user_id = user.id
       - If no subscription found, redirect to '/dashboard' (nothing to manage)
       - Create portal session: `stripe.billingPortal.sessions.create({ customer: stripe_customer_id, return_url: process.env.NEXT_PUBLIC_APP_URL + '/billing' })`
       - Call `redirect(portalSession.url)` — Server Action redirect

    **Imports:** stripe from '@/lib/stripe/client', createClient from '@/lib/supabase/server', redirect from 'next/navigation'

    **CRITICAL:** Do NOT trust any price info from client. Always use `process.env.STRIPE_PRICE_ID` server-side.
  </action>
  <verify>
    - File compiles: `npx tsc --noEmit src/lib/stripe/actions.ts`
    - Contains 'use server' directive
    - Both functions exported
    - createCheckoutSession sets metadata.user_id AND subscription_data.metadata.user_id
    - createPortalSession checks for existing subscription before creating portal session
  </verify>
  <done>
    Two Server Actions exported: createCheckoutSession (starts subscription) and createPortalSession (manages subscription via Stripe portal)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create billing page and post-checkout success page</name>
  <files>
    src/app/(dashboard)/billing/page.tsx
    src/app/(dashboard)/billing/success/page.tsx
  </files>
  <action>
    1. **Create `src/app/(dashboard)/billing/page.tsx`** (Server Component):
       - Get authenticated user via Supabase
       - Query subscriptions table for user's subscription (status, current_period_end, cancel_at_period_end, stripe_customer_id)
       - Display subscription status:
         - **No subscription:** "Free Plan" with "Subscribe for $29.99/month" button (form action = createCheckoutSession)
         - **Active subscription:** "Pro Plan - Active" with current period end date, "Manage Subscription" button (form action = createPortalSession)
         - **Active + cancel_at_period_end:** "Pro Plan - Cancels on {date}" with warning message, "Manage Subscription" button
         - **Canceled:** "Subscription Canceled" with "Resubscribe" button (form action = createCheckoutSession)
         - **Past due:** "Payment Failed" with warning, "Update Payment Method" button (form action = createPortalSession)
       - Use consistent styling: white card, shadows, rounded-lg (matching existing dashboard cards)
       - Import createCheckoutSession and createPortalSession from '@/lib/stripe/actions'

    2. **Create `src/app/(dashboard)/billing/success/page.tsx`** (Server Component):
       - Extract `session_id` from searchParams (Next.js 15 pattern: `searchParams: Promise<{ session_id?: string }>`, must await it)
       - If no session_id, redirect to '/dashboard'
       - Query Stripe directly: `stripe.checkout.sessions.retrieve(session_id, { expand: ['subscription'] })` — this handles the webhook race condition (PAY-11)
       - Get authenticated user via Supabase
       - Check local subscription record: query subscriptions table for user_id with `.maybeSingle()`
       - Determine activation state:
         - If `session.payment_status === 'paid'` OR `localSub?.status === 'active'` → show success state
         - Otherwise → show "Activating subscription..." with note to refresh
       - Success state shows: checkmark icon, "Subscription Active!", "You've been credited 10 monthly credits", link to '/dashboard'
       - Pending state shows: spinner/loading indicator, "Activating subscription...", "This usually takes a few seconds. Please refresh if it takes longer.", auto-refresh meta tag or manual refresh button

    **Styling:** Match existing dashboard aesthetic — bg-gray-50 background, white cards with shadow-sm/shadow, rounded-lg, consistent text colors.
  </action>
  <verify>
    - Both files compile: `npx tsc --noEmit`
    - Billing page displays different UI states based on subscription status
    - Success page handles searchParams with Next.js 15 Promise pattern
    - Success page queries Stripe API directly (not just database)
    - `npm run build` passes
  </verify>
  <done>
    Billing page shows subscription status with appropriate actions (subscribe, manage, resubscribe), and success page syncs directly with Stripe API to handle webhook race condition
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with all new routes
- Billing page renders for users with and without subscriptions
- Success page fetches from Stripe API directly (not just DB)
- Server Actions use redirect() for navigation
- No client-side Stripe package needed (all server-side)
- Existing Stripe customers reused (no duplicates)
</verification>

<success_criteria>
- createCheckoutSession creates Stripe session with user_id in metadata
- createPortalSession redirects to Stripe Customer Portal
- Billing page shows current subscription status with action buttons
- Success page handles webhook delay by querying Stripe directly
- All new routes accessible under /billing and /billing/success
</success_criteria>

<output>
After completion, create `.planning/phases/04-stripe-integration/04-03-SUMMARY.md`
</output>
