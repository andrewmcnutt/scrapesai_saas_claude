---
phase: 04-stripe-integration
plan: 05
type: execute
wave: 4
depends_on:
  - 04-04
files_modified: []
autonomous: false
requirements:
  - INFRA-04
  - PAY-01
  - PAY-02
  - PAY-03
  - PAY-04
  - PAY-05
  - PAY-06
  - PAY-07
  - PAY-08
  - PAY-09
  - PAY-10
  - PAY-11
  - PAY-12
  - PAY-13
  - PAY-14
  - CRED-01
  - CRED-02
  - CRED-03
  - CRED-04
  - CRED-05
  - CRED-09
  - CRED-10

must_haves:
  truths:
    - "Production build passes with zero errors"
    - "All Stripe integration pages render correctly"
    - "Human has verified the Stripe integration flow end-to-end"
  artifacts: []
  key_links: []
---

<objective>
Verify production build passes and get human verification of the complete Stripe integration.

Purpose: Final quality gate before Phase 4 is marked complete. Ensures all pages compile, render, and the integration flow is correct.
Output: Verified build + human approval
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-stripe-integration/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify production build passes</name>
  <files></files>
  <action>
    Run `npm run build` and verify:
    1. Build completes with zero errors
    2. All new routes compile:
       - /api/webhooks/stripe
       - /billing
       - /billing/success
    3. No TypeScript errors in any Stripe-related files
    4. No ESLint warnings that would block deployment

    If build fails, fix issues before proceeding to human verification.
  </action>
  <verify>
    `npm run build` exits with code 0 and all routes are listed in build output
  </verify>
  <done>
    Production build passes clean with all Stripe integration routes compiled
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Stripe integration</name>
  <files></files>
  <action>
    Human verifies the complete Stripe integration for Phase 4:
    1. Stripe SDK installed and configured
    2. Database migration for subscriptions + stripe_processed_events tables
    3. Stripe webhook handler with signature verification and idempotent event processing
    4. Checkout flow via Server Action with success page that syncs directly with Stripe
    5. Customer Portal access via Server Action
    6. Billing management page with subscription status display
    7. Tier-aware CreditBalance component with upgrade CTAs
    8. Free tier enforcement (3 lifetime credits with upgrade prompts)
    9. Updated generation action with tier-specific error messaging
    10. Billing link in sidebar navigation
  </action>
  <verify>
    **Pre-requisites:** Apply the SQL migration in `supabase/migrations/20260225_stripe_integration.sql` via Supabase SQL Editor. Set Stripe env vars in `.env.local`. Install Stripe CLI (`brew install stripe/stripe-cli/stripe` or equivalent).

    **Part A — UI Verification:**

    1. **Visit /dashboard** — confirm CreditBalance shows "Free Plan" with "X of 3 free credits"
    2. **Visit /billing** — confirm "Free Plan" status with "Subscribe for $29.99/month" button
    3. **Check sidebar** — confirm "Billing" navigation link appears
    4. **Visit /generate** — if 0 credits, confirm upgrade messaging appears

    **Part B — Stripe Checkout Flow** (requires Stripe test mode credentials):

    5. **Test Stripe Checkout:**
       a. Click subscribe button on /billing
       b. Complete checkout with test card (4242 4242 4242 4242)
       c. Verify /billing/success shows activation status
       d. Verify /billing shows "Pro Plan - Active"
       e. Verify CreditBalance updates to show "Pro Plan" with 10 credits
    6. **Test Customer Portal:**
       a. Click "Manage Subscription" on /billing
       b. Verify Stripe portal opens

    **Part C — Webhook Verification via Stripe CLI (PAY-04 through PAY-14):**

    This part validates signature verification, idempotency, and credit allocation -- the most critical behaviors in Phase 4.

    7. **Start webhook forwarding:**
       ```
       stripe listen --forward-to localhost:3000/api/webhooks/stripe
       ```
       Copy the webhook signing secret it prints (whsec_...) and ensure it matches STRIPE_WEBHOOK_SECRET in .env.local.

    8. **Test invoice.paid (PAY-06 — credit allocation):**
       ```
       stripe trigger invoice.paid
       ```
       - Verify webhook logs show event received and processed
       - Check credit_transactions table: a new row with type='monthly_allocation' and amount=10 should exist
       - Trigger again and verify idempotency: no duplicate credit row is created (PAY-05)

    9. **Test customer.subscription.created (PAY-07):**
       ```
       stripe trigger customer.subscription.created
       ```
       - Verify subscriptions table has a new row with status from the event

    10. **Test customer.subscription.deleted (PAY-09):**
        ```
        stripe trigger customer.subscription.deleted
        ```
        - Verify subscription record status updated to 'canceled'

    11. **Test signature rejection (PAY-04):**
        - Send a POST to `/api/webhooks/stripe` with a fake body and no valid signature header
        - Verify it returns 400 (not 200)

    **Part D — Production build:**

    12. **Production build** — verify `npm run build` passes clean

    Note: Parts B and C require Stripe test mode credentials and Stripe CLI respectively. If Stripe CLI is unavailable, Part C may be deferred, but it is strongly recommended before marking Phase 4 complete. Part A and Part D are mandatory.
  </verify>
  <done>Human approves Phase 4 Stripe integration as complete</done>
</task>

</tasks>

<verification>
- Production build passes with zero errors
- All new routes accessible and rendering
- Human has reviewed integration flow
</verification>

<success_criteria>
- `npm run build` exits 0
- Human approves Phase 4 completion
</success_criteria>

<output>
After completion, create `.planning/phases/04-stripe-integration/04-05-SUMMARY.md`
</output>
