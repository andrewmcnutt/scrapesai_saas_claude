---
phase: 04-stripe-integration
plan: 04
type: execute
wave: 3
depends_on:
  - 04-02
  - 04-03
files_modified:
  - src/lib/stripe/subscription-status.ts
  - src/components/CreditBalance.tsx
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/(dashboard)/generate/actions.ts
  - src/app/(dashboard)/layout.tsx
autonomous: true
requirements:
  - CRED-01
  - CRED-03
  - CRED-05
  - CRED-10
  - PAY-01

must_haves:
  truths:
    - "Free tier users are limited to 3 lifetime carousel generations (balance reaches 0, upgrade prompt shown)"
    - "When balance is 0, generation is prevented with clear upgrade messaging"
    - "Dashboard displays credit balance prominently with tier-aware messaging"
    - "CreditBalance component shows upgrade CTA when balance is low or zero"
    - "Billing link appears in sidebar navigation"
    - "Generation action returns upgrade-specific error when free user has 0 credits"
  artifacts:
    - path: "src/lib/stripe/subscription-status.ts"
      provides: "getUserSubscriptionStatus utility for tier and balance checks"
      exports: ["getUserSubscriptionStatus"]
    - path: "src/components/CreditBalance.tsx"
      provides: "Tier-aware credit balance display with upgrade CTA"
      contains: "createCheckoutSession"
    - path: "src/app/(dashboard)/generate/actions.ts"
      provides: "Updated generation action with tier-aware error messaging"
      contains: "upgrade"
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Sidebar with Billing navigation link"
      contains: "billing"
  key_links:
    - from: "src/components/CreditBalance.tsx"
      to: "src/lib/stripe/subscription-status.ts"
      via: "subscription status query for tier display"
      pattern: "getUserSubscriptionStatus|subscriptions"
    - from: "src/app/(dashboard)/generate/actions.ts"
      to: "subscriptions"
      via: "subscription check before showing upgrade prompt"
      pattern: "subscriptions"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "/billing"
      via: "navigation link"
      pattern: "href.*billing"
---

<objective>
Enforce free tier limits, update credit balance UI to be tier-aware with upgrade CTAs, update generation action error messaging, and add billing to navigation.

Purpose: This ties the Stripe subscription system to the user experience — free users see their 3-credit limit and upgrade prompts, paid users see their balance and subscription status, and the generation flow provides clear guidance when credits are exhausted.
Output: Subscription status utility, updated CreditBalance component, updated generation action, updated sidebar navigation
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-stripe-integration/04-RESEARCH.md
@.planning/phases/04-stripe-integration/04-02-SUMMARY.md
@.planning/phases/04-stripe-integration/04-03-SUMMARY.md
@src/components/CreditBalance.tsx
@src/app/(dashboard)/generate/actions.ts
@src/app/(dashboard)/dashboard/page.tsx
@src/app/(dashboard)/layout.tsx
@src/lib/stripe/actions.ts
@src/lib/stripe/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subscription status utility and update CreditBalance component</name>
  <files>
    src/lib/stripe/subscription-status.ts
    src/components/CreditBalance.tsx
  </files>
  <action>
    1. **Create `src/lib/stripe/subscription-status.ts`:**
       - Export `getUserSubscriptionStatus(userId: string, supabase: SupabaseClient)` function
       - Query in parallel (Promise.all):
         a. subscriptions table: select status, current_period_end, cancel_at_period_end where user_id = userId, maybeSingle()
         b. credit_transactions table: select amount where user_id = userId
       - Calculate balance as reduce((sum, tx) => sum + tx.amount, 0)
       - Determine isActiveSub: sub?.status === 'active' || sub?.status === 'trialing'
       - Return `UserSubscriptionStatus` object: { balance, isActiveSub, isFree: !isActiveSub, tier: isActiveSub ? 'paid' : 'free', cancelAtPeriodEnd: sub?.cancel_at_period_end ?? false, currentPeriodEnd: sub?.current_period_end ?? null }
       - Import types from '@/lib/stripe/types'
       - Import SupabaseClient type from '@supabase/supabase-js'

    2. **Update `src/components/CreditBalance.tsx`:**
       - Keep as 'use client' component
       - Add subscription status query alongside existing credit balance query:
         - Query subscriptions table for user's status, cancel_at_period_end, current_period_end
       - Display tier-aware UI:
         - **Free tier (no subscription):**
           - Title: "Free Plan"
           - Balance display: "{balance} of 3 free credits"
           - When balance > 0: "You have {balance} free carousel{s} remaining"
           - When balance = 0: "You've used all 3 free carousels"
           - Upgrade CTA button: "Upgrade to Pro - $29.99/mo" — wrap in form with action={createCheckoutSession}
           - Note: Since this is a client component, use a form element that posts to a route, OR import the server action and use it in a form. Use `<form action={createCheckoutSession}>` pattern since Server Actions work in client component forms.
         - **Paid tier (active subscription):**
           - Title: "Pro Plan"
           - Balance display: large number in indigo-600
           - "{balance} credits available"
           - If cancel_at_period_end: show "Cancels on {formatted date}" in yellow text
           - If balance < 3: show "Credits are running low" warning
           - "Manage subscription" link to /billing
         - **Past due:**
           - Title: "Pro Plan - Payment Issue"
           - Balance display with warning styling
           - "Update payment method" link to /billing
       - Keep the existing loading state
       - Import createCheckoutSession from '@/lib/stripe/actions' for the upgrade button form
       - Get user from Supabase auth to query subscriptions (the component already creates a supabase client)
  </action>
  <verify>
    - `npx tsc --noEmit src/lib/stripe/subscription-status.ts`
    - CreditBalance shows different UI for free vs paid users
    - Upgrade button uses createCheckoutSession server action
    - Free tier shows "X of 3 free credits"
    - `npm run build` passes
  </verify>
  <done>
    Subscription status utility provides tier/balance info; CreditBalance component is tier-aware showing upgrade CTA for free users and subscription details for paid users
  </done>
</task>

<task type="auto">
  <name>Task 2: Update generation action, dashboard, and sidebar navigation</name>
  <files>
    src/app/(dashboard)/generate/actions.ts
    src/app/(dashboard)/dashboard/page.tsx
    src/app/(dashboard)/layout.tsx
  </files>
  <action>
    1. **Update `src/app/(dashboard)/generate/actions.ts`:**
       - AFTER the credit deduction failure check (where it currently returns 'Insufficient credits. Please upgrade your plan.'), enhance the error message:
         - Query subscriptions table for user's subscription status
         - If no active subscription (free tier): return message "You've used all 3 free carousels. Upgrade to Pro for 10 credits/month." and add `needsUpgrade: true` to the return object
         - If active subscription but 0 credits: return message "No credits remaining. Your credits will refresh on your next billing date." and add `needsUpgrade: false`
         - This gives the generation wizard UI enough info to show the appropriate CTA

    2. **Update `src/app/(dashboard)/dashboard/page.tsx`:**
       - Add a subscription status section below the CTA:
         - Query subscriptions table for user's subscription
         - If no active subscription, show a subtle "Upgrade to Pro" card in the grid alongside CreditBalance and Account cards:
           - "Unlock unlimited potential" heading
           - "$29.99/month - 10 credits with rollover"
           - Form button with createCheckoutSession action
         - If active subscription with cancel_at_period_end, show "Your subscription cancels on {date}" info card
       - Import createCheckoutSession from '@/lib/stripe/actions'

    3. **Update `src/app/(dashboard)/layout.tsx`:**
       - Add "Billing" navigation link to the sidebar, after "Brand Settings" and before the bottom user/logout section
       - Use a credit card or dollar sign SVG icon
       - Link to `/billing`
       - Keep consistent styling with existing nav items: `flex items-center px-4 py-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100`
  </action>
  <verify>
    - Generation action returns `needsUpgrade` flag on credit failure
    - Dashboard shows upgrade card for free users
    - Sidebar has Billing navigation link
    - `npm run build` passes
  </verify>
  <done>
    Generation action provides tier-aware error messaging, dashboard shows subscription-aware cards, and Billing link appears in sidebar navigation
  </done>
</task>

</tasks>

<verification>
- Free user with 0 credits sees upgrade prompt in CreditBalance, dashboard, and generation flow
- Paid user sees credit count without upgrade nagging
- Sidebar navigation includes Billing link
- All existing functionality (generate, history, brand) still works
- `npm run build` passes clean
</verification>

<success_criteria>
- Free tier enforcement: users limited to 3 lifetime credits with clear upgrade prompts
- CreditBalance component shows correct tier and subscription info
- Generation action returns actionable error messages based on subscription status
- Dashboard shows upgrade CTA for free users
- Billing link in sidebar navigation
</success_criteria>

<output>
After completion, create `.planning/phases/04-stripe-integration/04-04-SUMMARY.md`
</output>
